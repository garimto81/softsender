<!--
  Soft Content Sender v11.15.0
  Build Time: 2025-10-18T15:37:10.434Z
  Build Mode: NORMAL

  âš ï¸  AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY
  Edit source files in src/ and run 'npm run build'
-->

<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
/* ============================================
   Design Tokens - Focus Mode UI System
   ============================================

   Purpose: ìƒë°©ì†¡ ìë§‰ ì‹œìŠ¤í…œì„ ìœ„í•œ ë””ìì¸ í† í°
   Based on: Think Hard í”„ë ˆì„ì›Œí¬ ë¶„ì„ ê²°ê³¼
   Target: ëª¨ë°”ì¼ í¼ìŠ¤íŠ¸ (393px~768px)

   ì°¸ê³ :
   - ì¸ì§€ì‹¬ë¦¬í•™ ê¸°ë°˜ (Hick's Law, Miller's Law, Fitts's Law)
   - ìƒë°©ì†¡ í™˜ê²½ ìµœì í™” (ìŠ¤íŠ¸ë ˆìŠ¤ ìƒí™© ëŒ€ì‘)
   - Apple HIG í„°ì¹˜ ê°€ì´ë“œë¼ì¸ (ìµœì†Œ 48px, ê¶Œì¥ 64px)

   ============================================ */

/* ============================================
   1. Color System
   ============================================ */

:root {
  /* --- Background --- */
  --color-bg: #0A0B0C;           /* ê±°ì˜ ê²€ì • (ëˆˆ í”¼ë¡œ ìµœì†Œí™”) */
  --color-surface: #131416;      /* ì¹´ë“œ/íŒ¨ë„ ë°°ê²½ */
  --color-surface-hover: #1C1D1F; /* hover ìƒíƒœ */
  --color-border: #2A2B2C;       /* êµ¬ë¶„ì„  (ê¸°ì¡´ ìœ ì§€) */

  /* --- Text --- */
  --color-text-primary: #FFFFFF;   /* ì£¼ìš” í…ìŠ¤íŠ¸ */
  --color-text-secondary: #A0A0A0; /* ë³´ì¡° í…ìŠ¤íŠ¸ */
  --color-text-disabled: #606060;  /* ë¹„í™œì„± í…ìŠ¤íŠ¸ */

  /* --- Semantic Colors (ì‹ í˜¸ë“± ì²´ê³„) --- */
  --color-success: #10B981;  /* ë…¹ìƒ‰ - ì„±ê³µ/ì™„ë£Œ */
  --color-warning: #F59E0B;  /* ì£¼í™© - ê²½ê³ /ì£¼ì˜ */
  --color-error: #EF4444;    /* ë¹¨ê°• - ì—ëŸ¬/ê¸´ê¸‰ */
  --color-info: #3B82F6;     /* íŒŒë‘ - ì •ë³´ */

  /* --- Mode Colors (ì§ê´€ì  ì—°ìƒ) --- */
  --color-mode-pu: #3B82F6;      /* íŒŒë‘ - ì¼ìƒ ì‘ì—… (Player Update) */
  --color-mode-elim: #EF4444;    /* ë¹¨ê°• - ê¸´ê¸‰ ìƒí™© (Eliminate) */
  --color-mode-l3: #8B5CF6;      /* ë³´ë¼ - íŠ¹ë³„ ì‘ì—… (Lower Third) */
  --color-mode-lb: #F59E0B;      /* ì£¼í™© - ìˆœìœ„ í‘œì‹œ (Leaderboard) */

  /* --- Accent --- */
  --color-accent: #06B6D4;       /* ì‹œì•ˆ - í¬ì»¤ í…Œë§ˆ, ì£¼ìš” ì•¡ì…˜ */

  /* --- Legacy Aliases (ê¸°ì¡´ ì½”ë“œ í˜¸í™˜) --- */
  --bg: #0E0F10;           /* ê¸°ì¡´ ë°°ê²½ìƒ‰ ìœ ì§€ */
  --panel: #141516;        /* ê¸°ì¡´ íŒ¨ë„ìƒ‰ ìœ ì§€ */
  --panel2: #1B1C1D;       /* ê¸°ì¡´ íŒ¨ë„2 ìœ ì§€ */
  --border: #2A2B2C;       /* ê¸°ì¡´ í…Œë‘ë¦¬ ìœ ì§€ */
  --txt: #F2F3F5;          /* ê¸°ì¡´ í…ìŠ¤íŠ¸ ìœ ì§€ */
  --sub: #B9C0CC;          /* ê¸°ì¡´ ë³´ì¡° í…ìŠ¤íŠ¸ ìœ ì§€ */
  --accent: #19D27C;       /* ê¸°ì¡´ accent ìƒ‰ìƒ ìœ ì§€ (ë…¹ìƒ‰) */
  --err: #FF6464;          /* ê¸°ì¡´ ì—ëŸ¬ ìƒ‰ìƒ ìœ ì§€ */
}

/* ============================================
   2. Typography System
   ============================================ */

:root {
  /* --- Type Scale (1.25 ë¹„ìœ¨, Major Third) --- */
  --text-xs: 12px;   /* ë³´ì¡° ì •ë³´ (ìµœì†Œ í¬ê¸°) */
  --text-sm: 16px;   /* ë ˆì´ë¸”, iOS ì¤Œ ë°©ì§€ ìµœì†Œê°’ */
  --text-base: 20px; /* ë³¸ë¬¸ (ì½ê¸° í¸ì•ˆí•œ í¬ê¸°) */
  --text-lg: 25px;   /* ì…ë ¥ê°’ (ëª…í™•í•œ ê°€ë…ì„±) */
  --text-xl: 31px;   /* ì œëª© */
  --text-2xl: 39px;  /* ë¯¸ë¦¬ë³´ê¸° (ìµœì¢… í™•ì¸ìš©) */

  /* --- Line Height --- */
  --leading-tight: 1.2;   /* ì œëª©ìš© */
  --leading-normal: 1.5;  /* ë³¸ë¬¸ (ê¸°ë³¸) */
  --leading-loose: 1.8;   /* ê¸´ í…ìŠ¤íŠ¸ */

  /* --- Font Weight --- */
  --font-normal: 400;
  --font-medium: 500;
  --font-bold: 700;
  --font-black: 900;

  /* --- Legacy Aliases (ê¸°ì¡´ ê°’ ìœ ì§€) --- */
  --fs-xs: var(--text-xs);
  --fs-sm: 19px;              /* ê¸°ì¡´ ê°’ ìœ ì§€ */
  --fs-base: 24px;            /* ê¸°ì¡´ ê°’ ìœ ì§€ */
  --fs-lg: var(--text-lg);
  --fs-h: 32px;               /* ê¸°ì¡´ ê°’ ìœ ì§€ */
}

/* ============================================
   3. Spacing System (8px ê¸°ì¤€)
   ============================================ */

:root {
  /* --- Base Unit: 8px --- */
  --space-1: 4px;   /* 0.5x - ìµœì†Œ ê°„ê²© */
  --space-2: 8px;   /* 1x - ê¸°ë³¸ ë‹¨ìœ„ */
  --space-3: 12px;  /* 1.5x - íŒ¨ë”©/ë§ˆì§„ */
  --space-4: 16px;  /* 2x - ìš”ì†Œ ê°„ê²© */
  --space-6: 24px;  /* 3x - ì„¹ì…˜ êµ¬ë¶„ */
  --space-8: 32px;  /* 4x - í° ì„¹ì…˜ */
  --space-12: 48px; /* 6x - ë¸”ë¡ êµ¬ë¶„ */
  --space-16: 64px; /* 8x - í™”ë©´ êµ¬ë¶„ */

  /* --- Component Spacing --- */
  --touch-min: 48px;     /* Apple HIG ìµœì†Œ í„°ì¹˜ ì˜ì—­ */
  --touch-target: 64px;  /* ê¶Œì¥ í„°ì¹˜ ì˜ì—­ (ìƒë°©ì†¡ í™˜ê²½) */
  --input-height: 56px;  /* ì…ë ¥ í•„ë“œ ë†’ì´ (í¸ì•ˆí•œ í„°ì¹˜) */

  /* --- Safe Area (iOS) --- */
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-right: env(safe-area-inset-right, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-left: env(safe-area-inset-left, 0px);

  /* --- Legacy Aliases --- */
  --radius: 16px;        /* ê¸°ì¡´ border-radius */
  --pad: 18px;           /* ê¸°ì¡´ padding */
  --touch: var(--touch-target); /* ê¸°ì¡´ í„°ì¹˜ ì˜ì—­ */
}

/* ============================================
   4. Animation System
   ============================================ */

:root {
  /* --- Duration --- */
  --duration-instant: 0ms;      /* ì¦‰ì‹œ (íŠ¸ëœì§€ì…˜ ì œê±°) */
  --duration-fast: 100ms;       /* ë¹ ë¥¸ í”¼ë“œë°± (ì…ë ¥ ë°˜ì‘) */
  --duration-normal: 200ms;     /* ì¼ë°˜ ì „í™˜ (ë²„íŠ¼ hover) */
  --duration-slow: 400ms;       /* ê°•ì¡° ì „í™˜ (ëª¨ë“œ ë³€ê²½) */

  /* --- Easing Functions --- */
  --ease-in: cubic-bezier(0.4, 0, 1, 1);          /* ê°€ì† (ì‹œì‘ ëŠë¦¼) */
  --ease-out: cubic-bezier(0, 0, 0.2, 1);         /* ê°ì† (ë ëŠë¦¼) */
  --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);    /* ê°€ì†+ê°ì† */
  --ease-bounce: cubic-bezier(0.68, -0.55, 0.27, 1.55); /* íŠ•ê¹€ íš¨ê³¼ */
}

/* ============================================
   5. Shadow System (Depth)
   ============================================ */

:root {
  /* --- Elevation --- */
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.2);
  --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.3);

  /* --- Focus/Active State --- */
  --ring-offset: 2px;
  --ring-width: 4px;
  --ring-color: rgba(6, 182, 212, 0.3); /* accent ìƒ‰ìƒ ê¸°ë°˜ */
}

/* ============================================
   6. Z-Index Scale (Stacking Order)
   ============================================ */

:root {
  --z-base: 0;       /* ê¸°ë³¸ ë ˆì´ì–´ */
  --z-dropdown: 10;  /* ë“œë¡­ë‹¤ìš´ */
  --z-sticky: 20;    /* ê³ ì • í—¤ë” */
  --z-modal: 30;     /* ëª¨ë‹¬ ë°°ê²½ */
  --z-toast: 40;     /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */
  --z-tooltip: 50;   /* íˆ´íŒ (ìµœìƒìœ„) */
}

/* ============================================
   7. Breakpoints (Mobile First)
   ============================================ */

:root {
  --bp-mobile: 393px;   /* iPhone 14 Pro ê¸°ì¤€ */
  --bp-tablet: 768px;   /* iPad ê¸°ì¤€ */
  --bp-desktop: 1024px; /* Desktop ê¸°ì¤€ */
}

/* ============================================
   8. Component-Specific Tokens
   ============================================ */

:root {
  /* --- Button --- */
  --btn-height: var(--touch-target);      /* 64px */
  --btn-padding-x: var(--space-6);        /* 24px */
  --btn-font-size: var(--text-base);      /* 20px */
  --btn-font-weight: var(--font-black);   /* 900 */
  --btn-border-radius: var(--radius);     /* 16px */

  /* --- Input --- */
  --input-height: var(--touch-target);    /* 64px */
  --input-padding-x: var(--pad);          /* 18px */
  --input-font-size: var(--text-base);    /* 20px */
  --input-border-radius: var(--radius);   /* 16px */
  --input-border-width: 1px;

  /* --- Toast --- */
  --toast-min-width: 280px;
  --toast-max-width: 90vw;
  --toast-padding: 12px 16px;
  --toast-border-radius: 14px;
}

/* ============================================
   9. Utility Classes (Future Use)
   ============================================ */

/*
  Note: í˜„ì¬ëŠ” í† í°ë§Œ ì •ì˜, ì‹¤ì œ í´ë˜ìŠ¤ëŠ” v11ì—ì„œ ì¶”ê°€ ì˜ˆì •

  ì˜ˆì‹œ:
  .text-primary { color: var(--color-text-primary); }
  .bg-surface { background: var(--color-surface); }
  .p-4 { padding: var(--space-4); }
*/

/* ============================================
   10. Print / Dark Mode (Future Use)
   ============================================ */

/*
  Note: í˜„ì¬ëŠ” ë‹¤í¬ ëª¨ë“œ ê¸°ë³¸ê°’ë§Œ ì œê³µ
  ë¼ì´íŠ¸ ëª¨ë“œëŠ” ì‚¬ìš©ì ìš”ì²­ ì‹œ ì¶”ê°€ ì˜ˆì •
*/

/* ============================================
   11. Performance Optimizations
   ============================================ */

:root {
  /* GPU ê°€ì† í™œì„±í™” */
  --transform-gpu: translateZ(0);

  /* í…ìŠ¤íŠ¸ ë Œë”ë§ ìµœì í™” */
  --text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}


/* ============================================
   Legacy Styles (Design Tokens ê¸°ë°˜)
   ============================================
   Note: ìƒ‰ìƒ/íƒ€ì´í¬/ê³µê°„ ë³€ìˆ˜ëŠ” design-tokens.cssì— ì •ì˜ë¨
   ì—¬ê¸°ì„œëŠ” ë ˆì´ì•„ì›ƒ/ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼ë§Œ ê´€ë¦¬
   ============================================ */

html,body{background:var(--bg); color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; font-size:var(--fs-base); margin:0; overflow:hidden; height:100vh;}
.wrap{max-width:980px;margin:0 auto;padding:6px 10px 50px; height:100vh; overflow-y:auto; box-sizing:border-box;}
header{display:flex;justify-content:space-between;align-items:flex-end;margin:2px 0 4px;}
h1{font-size:1.1em;margin:2px 0;}
#status{font-size:var(--fs-sm);color:#9fe7cc;}

.field{margin:5px 0;}
label{display:block;margin:2px 0 3px;color:var(--sub);font-size:0.75em;}
input,select,textarea{
  width:100%; background:var(--panel); color:var(--txt); border:1px solid var(--border);
  border-radius:12px; padding:0 14px; height:44px; box-sizing:border-box; font-size:0.9em;
}
textarea{min-height:90px; padding:10px 14px; white-space:pre-wrap; line-height:1.2;}

.row{display:grid; gap:8px;}
.row.two{grid-template-columns:1fr 1fr;}
.row.three{grid-template-columns:1fr 1fr 1fr;}

.tabs{display:flex;gap:6px;margin:8px 0;}
.tabs button{flex:1;height:40px;border-radius:10px;border:1px solid var(--border);background:var(--panel2);color:#0b1d14;background:linear-gradient(0deg,#19D27C,#19D27C);opacity:.85;font-size:0.85em;}
.tabs button.active{opacity:1;}
.btn{height:44px;padding:0 14px;border-radius:12px;border:1px solid var(--border);font-weight:800;font-size:0.9em;}
.btn.primary{background:var(--accent);color:#0b1d14;}
.btn.ghost{background:var(--panel2);color:#fff;}

.muted{color:var(--sub);font-size:var(--fs-sm);}
#toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:var(--panel2);color:#fff;padding:12px 16px;border-radius:14px;border:1px solid var(--border);opacity:0;pointer-events:none;z-index:10;}
#toast.show{opacity:1;transition:opacity .15s;}
#toast.err{border-color:var(--err);color:#ffdada;}

/* ë¡œë”© ì˜¤ë²„ë ˆì´ */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(11, 29, 20, 0.95);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
}

.loading-content {
  text-align: center;
  padding: 40px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  max-width: 400px;
  width: 90%;
}

.spinner {
  width: 50px;
  height: 50px;
  margin: 0 auto 20px;
  border: 4px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-message {
  font-size: 1.1em;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 12px;
}

.loading-details {
  font-size: 0.9em;
  color: var(--sub);
  line-height: 1.5;
  white-space: pre-line;
  min-height: 40px;
}

.lb-row{display:grid; grid-template-columns: 1.6fr 1fr; gap:10px; align-items:center;}
.lb-list{display:flex; flex-direction:column; gap:10px;}

/* ë°°ì¹˜ ë¹Œë” ìµœì í™” */
details > summary {
  list-style: none;
}
details > summary::-webkit-details-marker {
  display: none;
}
details[open] > summary {
  background: var(--panel2) !important;
}

  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Soft Content Sender</h1>
      <div class="muted" style="font-size:0.75em; margin-top:-4px;">v11.15.0 (2025-01-17)</div>
    </div>
    <div id="status">ë¡œë”©ì¤‘â€¦</div>
  </header>

  <!-- ì‹œíŠ¸ID ì˜¤ë²„ë¼ì´ë“œ -->
  <section class="field">
    <label>Sheet IDs</label>
    <div class="row two">
      <input id="cueId" placeholder="CUE Sheet ID(ì˜µì…˜)" />
      <input id="typeId" placeholder="TYPE Sheet ID(ì˜µì…˜)" />
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px;">
      <button class="btn ghost" id="btnSaveIds">ID ì €ì¥</button>
      <button class="btn ghost" id="btnClearIds">ID ì´ˆê¸°í™”</button>
    </div>
    <div class="muted" id="idsHint" style="margin-top:6px;"></div>
  </section>

  <section class="field">
    <div class="row two">
      <div class="field">
        <label>í–‰ ì„ íƒ(ì‹œê°„)</label>
        <div style="display:flex;gap:12px;align-items:center;">
          <input id="chkAuto" type="checkbox" checked style="width:auto;height:auto;transform:scale(1.4);" />
          <span class="muted">í˜„ì¬ ì‹œê° ìë™ ì„ íƒ</span>
        </div>
      </div>
      <div class="field">
        <label>ì‹œê°„ ë“œë¡­ë‹¤ìš´(Â±20ë¶„)</label>
        <select id="selTime"><option value="">(ë¯¸ì„ íƒ: í˜„ì¬ì‹œê°)</option></select>
      </div>
    </div>
  </section>

  <section class="field">
    <div class="row two">
      <div class="field">
        <label>íŒŒì¼ëª…(ì „ì†¡ ì „ ìˆ˜ì • ê°€ëŠ¥) â€” í˜•ì‹: <b>HHmm_name_mode</b></label>
        <input id="fileName" placeholder="ì˜ˆ: 1742_John_Doe_PU" />
      </div>
      <div class="field">
        <label>ëª¨ë“œ</label>
        <div class="tabs">
          <button id="tabPU" class="active">í”Œë ˆì´ì–´ ì—…ë°ì´íŠ¸(PU)</button>
          <button id="tabELIM">í”Œë ˆì´ì–´ íƒˆë½(ELIM)</button>
          <button id="tabL3">í”Œë ˆì´ì–´ ì†Œê°œ(L3)</button>
        </div>
      </div>
    </div>
  </section>

  <section class="field">
    <div class="field">
      <label>í…Œì´ë¸” ì„ íƒ</label>
      <select id="selRoomTable"><option value="">-</option></select>
    </div>

    <div class="field">
      <label>ì¢Œì„ ì„ íƒ</label>
      <select id="selSeat"><option value="">ì¢Œì„ ì„ íƒ</option></select>
    </div>

    <div class="field" id="singleFields">
      <label>êµ­ê°€ ì½”ë“œ (2ìë¦¬)</label>
      <input id="countryCode" placeholder="ì˜ˆ: US, KR" readonly />
    </div>
  </section>

  <!-- PU -->
  <section id="panelPU" class="field">
    <div class="row two">
      <div class="field">
        <label>ì¹©ìŠ¤íƒ(ì‰¼í‘œ í¬í•¨) *</label>
        <input id="stackAmt" placeholder="ì˜ˆ: 1,234,000" inputmode="numeric" />
      </div>
      <div class="field">
        <label>Big Blind(ì •ìˆ˜) *</label>
        <input id="bigBlind" placeholder="ì˜ˆ: 20000" inputmode="numeric" />
      </div>
    </div>
    <div class="row two">
      <div class="field">
        <label>ê³„ì‚°ëœ BB (ìë™, ë°˜ì˜¬ë¦¼)</label>
        <input id="stackBBView" readonly placeholder="ì˜ˆ: 62BB" />
      </div>
      <input id="stackBB" type="hidden" />
    </div>
  </section>


  <!-- ELIM -->
  <section id="panelELIM" class="field" style="display:none;">
    <p class="muted">"ì´ë¦„ / êµ­ê¸°<br>ELIMINATED" í˜•ì‹ìœ¼ë¡œ Jì…€ì— ì¶”ê°€ë©ë‹ˆë‹¤.</p>
  </section>

  <!-- L3 -->
  <section id="panelL3" class="field" style="display:none;">
    <p class="muted">"í”„ë¡œí•„ ìë§‰" + ì´ë¦„ 2ì¤„ì´ Jì…€ì— ì¶”ê°€ë©ë‹ˆë‹¤.</p>
  </section>


  <!-- ì•¡ì…˜ ë²„íŠ¼ (ì…ë ¥ ì§í›„ ë°”ë¡œ ì²˜ë¦¬) -->
  <section class="field" style="display:flex;gap:12px;justify-content:flex-end;align-items:center;">
    <button class="btn ghost" id="btnAddToBatch" style="display:none;">
      â• ë°°ì¹˜ì— ì¶”ê°€
    </button>
    <button class="btn primary" id="btnSend" style="min-width:200px;">ì „ì†¡</button>
  </section>

  <!-- ë°°ì¹˜ ë¦¬ìŠ¤íŠ¸ (í•­ëª© ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
  <section id="batchSection" class="field" style="display:none; background:var(--panel2); padding:var(--pad); border-radius:var(--radius); border:2px solid var(--accent);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <label style="margin:0;">ğŸ“¦ ë°°ì¹˜ ëŒ€ê¸° ì¤‘ (<span id="batchCount">0</span>ê±´)</label>
      <button class="btn ghost" id="btnClearBatch" style="height:auto; padding:8px 14px; font-size:0.9em;">
        ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
      </button>
    </div>

    <!-- ë°°ì¹˜ ë¦¬ìŠ¤íŠ¸ -->
    <div id="batchList" style="max-height:250px; overflow-y:auto; -webkit-overflow-scrolling:touch;">
      <!-- ë™ì  ìƒì„± -->
    </div>
  </section>

  <!-- ë¯¸ë¦¬ë³´ê¸° (í†µí•©) -->
  <section class="field">
    <label id="previewLabel">ë¯¸ë¦¬ë³´ê¸°</label>
    <textarea id="preview" readonly></textarea>
  </section>

  <section style="margin-top:12px;">
    <div class="muted" id="footerInfo"></div>
  </section>
</div>

<div id="toast"></div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <div id="loadingMessage" class="loading-message">ë¡œë”© ì¤‘...</div>
    <div id="loadingDetails" class="loading-details"></div>
  </div>
</div>

<script>
  // ìƒìˆ˜ ì •ì˜
const CONSTANTS = {
  TOAST_DURATION: 1800,
  DEFAULT_SEAT_INDEX: 1,
  DEBOUNCE_DELAY: 300,
  MODES: {
    PU: 'PU',
    ELIM: 'ELIM',
    L3: 'L3'
  },
  DISPLAY: {
    GRID: 'grid',
    BLOCK: 'block',
    NONE: 'none'
  }
};

// localStorage í‚¤ (Sheet ID ë°±ì—…ìš©)
const LS_KEYS = {
  CUE: 'SCS_CUE_ID',
  TYPE: 'SCS_TYPE_ID'
};

const state = {
  mode: CONSTANTS.MODES.PU,
  tz: 'Asia/Seoul',
  typeRows: [],
  byRoom: {},
  byRoomTable: {},
  tableList: [],     // Room+Table í†µí•© ëª©ë¡
  timeCenter: '',
  cueId: '',
  typeId: '',
  batch: []          // ë°°ì¹˜ ì „ì†¡ìš© ë°°ì—´
};

  /* ===== í†µí•© ë¡œë”© ê´€ë¦¬ì (Unified Loading Manager) ===== */

/**
 * ë¡œë”© ìƒíƒœ ê´€ë¦¬ ë° ì‚¬ìš©ì ì‹¤ìˆ˜ ë°©ì§€
 *
 * ê¸°ëŠ¥:
 * 1. ì „ì—­ ë¡œë”© ìƒíƒœ ì¶”ì 
 * 2. ì¤‘ë³µ ìš”ì²­ ë°©ì§€ (í•œ ë²ˆì— í•˜ë‚˜ì˜ ì‘ì—…ë§Œ)
 * 3. UI ë¹„í™œì„±í™” (ë²„íŠ¼, ì…ë ¥ í•„ë“œ ë“±)
 * 4. ì§„í–‰ ìƒí™© í‘œì‹œ
 * 5. ì—ëŸ¬ ì²˜ë¦¬ ë° ë³µêµ¬
 */

const LoadingManager = {
  // ìƒíƒœ
  isLoading: false,
  currentOperation: null,
  disabledElements: [],

  /**
   * ë¡œë”© ì‹œì‘
   * @param {string} operation - ì‘ì—… ì´ë¦„ (ì˜ˆ: 'INIT', 'SEND', 'SAVE_IDS')
   * @param {string} message - ë¡œë”© ë©”ì‹œì§€
   * @param {string} details - ìƒì„¸ ì •ë³´ (ì„ íƒ)
   */
  start(operation, message, details = '') {
    // ì¤‘ë³µ ìš”ì²­ ë°©ì§€
    if (this.isLoading) {
      console.warn(`âš ï¸ [LoadingManager] ì‘ì—… ì¤‘ë³µ ì°¨ë‹¨: ${this.currentOperation} â†’ ${operation}`);
      return false;
    }

    this.isLoading = true;
    this.currentOperation = operation;

    // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
    showLoading(message, details);

    // UI ë¹„í™œì„±í™”
    this.disableUI();

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    setStatus('ì‘ì—… ì¤‘â€¦');

    console.log(`ğŸ”„ [LoadingManager] ì‹œì‘: ${operation}`);
    return true;
  },

  /**
   * ë¡œë”© ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
   * @param {string} message - ì—…ë°ì´íŠ¸ ë©”ì‹œì§€
   * @param {string} details - ìƒì„¸ ì •ë³´ (ì„ íƒ)
   */
  update(message, details = '') {
    if (!this.isLoading) {
      console.warn('âš ï¸ [LoadingManager] ë¡œë”© ì¤‘ì´ ì•„ë‹Œë° update í˜¸ì¶œë¨');
      return;
    }

    updateLoading(message, details);
    console.log(`ğŸ“Š [LoadingManager] ì§„í–‰: ${message}`);
  },

  /**
   * ë¡œë”© ì¢…ë£Œ (ì„±ê³µ)
   * @param {string} message - ì™„ë£Œ ë©”ì‹œì§€ (ì„ íƒ)
   */
  success(message = '') {
    if (!this.isLoading) {
      console.warn('âš ï¸ [LoadingManager] ë¡œë”© ì¤‘ì´ ì•„ë‹Œë° success í˜¸ì¶œë¨');
      return;
    }

    console.log(`âœ… [LoadingManager] ì„±ê³µ: ${this.currentOperation}`);

    // ì§§ì€ ë”œë ˆì´ í›„ ì¢…ë£Œ (ì‚¬ìš©ìê°€ ì™„ë£Œ ë©”ì‹œì§€ í™•ì¸ ê°€ëŠ¥)
    setTimeout(() => {
      hideLoading();
      this.enableUI();
      setStatus('ì¤€ë¹„ë¨');

      if (message) {
        toast(message, true);
      }

      this.reset();
    }, 300);
  },

  /**
   * ë¡œë”© ì¢…ë£Œ (ì—ëŸ¬)
   * @param {string} errorMsg - ì—ëŸ¬ ë©”ì‹œì§€
   * @param {boolean} showToast - í† ìŠ¤íŠ¸ í‘œì‹œ ì—¬ë¶€ (ê¸°ë³¸: true)
   */
  error(errorMsg, showToast = true) {
    if (!this.isLoading) {
      console.warn('âš ï¸ [LoadingManager] ë¡œë”© ì¤‘ì´ ì•„ë‹Œë° error í˜¸ì¶œë¨');
      return;
    }

    console.error(`âŒ [LoadingManager] ì—ëŸ¬: ${this.currentOperation} - ${errorMsg}`);

    hideLoading();
    this.enableUI();
    setStatus('ì—ëŸ¬');

    if (showToast) {
      toast(`âŒ ${errorMsg}`, false);
    }

    this.reset();
  },

  /**
   * ìƒíƒœ ì´ˆê¸°í™”
   */
  reset() {
    this.isLoading = false;
    this.currentOperation = null;
  },

  /**
   * UI ë¹„í™œì„±í™” (ë²„íŠ¼, ì…ë ¥ í•„ë“œ ë“±)
   */
  disableUI() {
    // ë¹„í™œì„±í™”í•  ìš”ì†Œ ì„ íƒ
    const selectors = [
      'button',
      'input:not([type="hidden"])',
      'select',
      'textarea'
    ];

    selectors.forEach(selector => {
      document.querySelectorAll(selector).forEach(el => {
        if (!el.disabled) {
          el.disabled = true;
          this.disabledElements.push(el);
        }
      });
    });

    console.log(`ğŸ”’ [LoadingManager] UI ë¹„í™œì„±í™”: ${this.disabledElements.length}ê°œ ìš”ì†Œ`);
  },

  /**
   * UI í™œì„±í™”
   */
  enableUI() {
    this.disabledElements.forEach(el => {
      el.disabled = false;
    });

    console.log(`ğŸ”“ [LoadingManager] UI í™œì„±í™”: ${this.disabledElements.length}ê°œ ìš”ì†Œ`);
    this.disabledElements = [];
  },

  /**
   * ë¡œë”© ì¤‘ì¸ì§€ í™•ì¸
   * @returns {boolean}
   */
  isActive() {
    return this.isLoading;
  },

  /**
   * í˜„ì¬ ì‘ì—… ê°€ì ¸ì˜¤ê¸°
   * @returns {string|null}
   */
  getCurrentOperation() {
    return this.currentOperation;
  }
};

/**
 * ë˜í¼ í•¨ìˆ˜: google.script.run í˜¸ì¶œ ì‹œ ìë™ ë¡œë”© ì²˜ë¦¬
 *
 * @param {string} operation - ì‘ì—… ì´ë¦„
 * @param {string} loadingMessage - ë¡œë”© ë©”ì‹œì§€
 * @param {Function} serverFunction - ì„œë²„ í•¨ìˆ˜ (google.script.run.xxx)
 * @param {Object} callbacks - ì½œë°± í•¨ìˆ˜ë“¤
 *   - onSuccess: ì„±ê³µ ì‹œ ì½œë°±
 *   - onError: ì—ëŸ¬ ì‹œ ì½œë°± (ì„ íƒ)
 *   - onComplete: ì™„ë£Œ ì‹œ ì½œë°± (ì„ íƒ)
 * @param {Array} args - ì„œë²„ í•¨ìˆ˜ ì¸ìë“¤
 *
 * @example
 * withLoading('SAVE_IDS', 'ID ì €ì¥ ì¤‘...',
 *   google.script.run.saveUserPreference,
 *   {
 *     onSuccess: (res) => {
 *       if (res.ok) {
 *         LoadingManager.success('ì €ì¥ ì™„ë£Œ');
 *       } else {
 *         LoadingManager.error(res.error);
 *       }
 *     }
 *   },
 *   [cueId, typeId]
 * );
 */
function withLoading(operation, loadingMessage, serverFunction, callbacks, args = []) {
  // ì¤‘ë³µ ìš”ì²­ ì°¨ë‹¨
  if (!LoadingManager.start(operation, loadingMessage)) {
    toast('âš ï¸ ì´ì „ ì‘ì—…ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì™„ë£Œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.', false);
    return;
  }

  // ì„œë²„ í˜¸ì¶œ
  const runner = google.script.run
    .withSuccessHandler(res => {
      if (callbacks.onSuccess) {
        callbacks.onSuccess(res);
      }
      if (callbacks.onComplete) {
        callbacks.onComplete(res);
      }
    })
    .withFailureHandler(err => {
      const errorMsg = err?.message || err || 'unknown';

      if (callbacks.onError) {
        callbacks.onError(errorMsg);
      } else {
        LoadingManager.error(`ì„œë²„ ì˜¤ë¥˜: ${errorMsg}`);
      }

      if (callbacks.onComplete) {
        callbacks.onComplete(null, errorMsg);
      }
    });

  // í•¨ìˆ˜ í˜¸ì¶œ
  const funcName = serverFunction.toString().match(/\.(\w+)$/)?.[1] || 'unknown';
  runner[funcName](...args);
}

/**
 * ì‘ì—… ì¤‘ ì‚¬ìš©ì ì‹¤ìˆ˜ ë°©ì§€ (í˜ì´ì§€ ì´íƒˆ ê²½ê³ )
 */
window.addEventListener('beforeunload', (e) => {
  if (LoadingManager.isActive()) {
    e.preventDefault();
    e.returnValue = 'ì‘ì—…ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?';
    return e.returnValue;
  }
});

  function toast(msg, ok=true){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='show'+(ok?'':' err');
  setTimeout(()=>t.className='', CONSTANTS.TOAST_DURATION);
}
function setStatus(s){ document.getElementById('status').textContent=s; }

/* ===== ë¡œë”© ì˜¤ë²„ë ˆì´ ê´€ë¦¬ ===== */
function showLoading(message, details){
  const overlay = document.getElementById('loadingOverlay');
  const msgEl = document.getElementById('loadingMessage');
  const detailsEl = document.getElementById('loadingDetails');

  msgEl.textContent = message || 'ë¡œë”© ì¤‘...';
  detailsEl.textContent = details || '';
  overlay.style.display = 'flex';
}

function updateLoading(message, details){
  const msgEl = document.getElementById('loadingMessage');
  const detailsEl = document.getElementById('loadingDetails');

  if (message) msgEl.textContent = message;
  if (details) detailsEl.textContent = details;
}

function hideLoading(){
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = 'none';
}

/* ===== Sheet ID ì €ì¥/ì´ˆê¸°í™” (Properties Service ì‚¬ìš©) ===== */
function loadIdsFromLocal(){
  // ì„œë²„ì—ì„œ ì‚¬ìš©ìë³„ ì €ì¥ëœ ID ë¡œë“œ (localStorageëŠ” ë°±ì—…ìš©)
  const localCue = localStorage.getItem(LS_KEYS.CUE) || '';
  const localType = localStorage.getItem(LS_KEYS.TYPE) || '';

  // ì„ì‹œë¡œ ë¡œì»¬ ê°’ í‘œì‹œ (ì„œë²„ ì‘ë‹µ ì „)
  if (localCue) document.getElementById('cueId').value = localCue;
  if (localType) document.getElementById('typeId').value = localType;
  state.cueId = localCue;
  state.typeId = localType;
  renderIdsHint();
}

function saveIds(){
  const cue = document.getElementById('cueId').value.trim();
  const type = document.getElementById('typeId').value.trim();

  // ë¡œë”© ì‹œì‘
  if (!LoadingManager.start('SAVE_IDS', 'Sheet ID ì €ì¥ ì¤‘...', 'ì„œë²„ì— ì˜êµ¬ ì €ì¥í•©ë‹ˆë‹¤...')) {
    return;
  }

  // ì„œë²„ì— ì €ì¥ (ì˜êµ¬ ì €ì¥)
  google.script.run
    .withSuccessHandler(res => {
      if (res?.ok) {
        // localStorageì—ë„ ë°±ì—… ì €ì¥
        if (cue) localStorage.setItem(LS_KEYS.CUE, cue); else localStorage.removeItem(LS_KEYS.CUE);
        if (type) localStorage.setItem(LS_KEYS.TYPE, type); else localStorage.removeItem(LS_KEYS.TYPE);

        state.cueId = cue;
        state.typeId = type;
        renderIdsHint();
        LoadingManager.success('âœ… ID ì €ì¥ ì™„ë£Œ (ì„œë²„ì— ì˜êµ¬ ì €ì¥ë¨)');

        // ì €ì¥ í›„ ì‹œíŠ¸ ì¬ë¡œë“œ
        setTimeout(() => reloadSheets(), 500);
      } else {
        LoadingManager.error('ì €ì¥ ì‹¤íŒ¨: ' + (res?.error || 'unknown'));
      }
    })
    .withFailureHandler(err => {
      LoadingManager.error('ì„œë²„ ì˜¤ë¥˜: ' + (err?.message || err));
    })
    .saveUserPreference(cue, type);
}

// ìë™ ì €ì¥ í•¨ìˆ˜ (ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ)
function autoSaveIds(){
  const cue = document.getElementById('cueId').value.trim();
  const type = document.getElementById('typeId').value.trim();

  // localStorageì— ì„ì‹œ ì €ì¥
  if (cue) localStorage.setItem(LS_KEYS.CUE, cue); else localStorage.removeItem(LS_KEYS.CUE);
  if (type) localStorage.setItem(LS_KEYS.TYPE, type); else localStorage.removeItem(LS_KEYS.TYPE);

  state.cueId = cue;
  state.typeId = type;
  renderIdsHint();

  // ì„œë²„ì—ë„ ìë™ ì €ì¥ (ë¹„ë™ê¸°)
  google.script.run
    .withSuccessHandler(() => {
      // ì¡°ìš©íˆ ì„±ê³µ (í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì—†ìŒ)
    })
    .saveUserPreference(cue, type);
}

function clearIds(){
  // ë¡œë”© ì‹œì‘
  if (!LoadingManager.start('CLEAR_IDS', 'Sheet ID ì´ˆê¸°í™” ì¤‘...', 'ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤...')) {
    return;
  }

  // ì„œë²„ì—ì„œ ì‚­ì œ
  google.script.run
    .withSuccessHandler(res => {
      if (res?.ok) {
        // localStorageë„ ì´ˆê¸°í™”
        localStorage.removeItem(LS_KEYS.CUE);
        localStorage.removeItem(LS_KEYS.TYPE);

        state.cueId = '';
        state.typeId = '';
        document.getElementById('cueId').value = '';
        document.getElementById('typeId').value = '';
        renderIdsHint();
        LoadingManager.success('âœ… ID ì´ˆê¸°í™” ì™„ë£Œ (ê¸°ë³¸ê°’ ì‚¬ìš©)');

        // ì´ˆê¸°í™” í›„ ì‹œíŠ¸ ì¬ë¡œë“œ
        setTimeout(() => reloadSheets(), 500);
      } else {
        LoadingManager.error('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + (res?.error || 'unknown'));
      }
    })
    .withFailureHandler(err => {
      LoadingManager.error('ì„œë²„ ì˜¤ë¥˜: ' + (err?.message || err));
    })
    .clearUserPreference();
}

function renderIdsHint(){
  const c = state.cueId ? `CUE=${state.cueId}` : 'CUE=ê¸°ë³¸ê°’';
  const t = state.typeId? `TYPE=${state.typeId}`: 'TYPE=ê¸°ë³¸ê°’';
  document.getElementById('idsHint').textContent = `í˜„ì¬ ì‚¬ìš© ì¤‘: ${c} | ${t}`;
}

/* ì¸ë±ì‹± */
function indexTypeRows(rows){
  state.byRoom={}; state.byRoomTable={}; state.tableList=[];
  rows.forEach(r=>{
    (state.byRoom[r.room] ||= []).push(r);
    const key = r.room + '|' + r.tno;
    (state.byRoomTable[key] ||= []).push(r);
  });

  // Room+Table í†µí•© ëª©ë¡ ìƒì„±
  Object.keys(state.byRoomTable).forEach(key => {
    const [room, tno] = key.split('|');
    const tname = state.byRoomTable[key][0]?.tname || '';
    state.tableList.push({
      key,
      label: tname ? `${room} - ${tname} (Table ${tno})` : `${room} - Table ${tno}`,
      room,
      tno
    });
  });

  // ì •ë ¬: Room â†’ Table No.
  state.tableList.sort((a,b) => {
    if (a.room !== b.room) return a.room.localeCompare(b.room);
    return Number(a.tno) - Number(b.tno);
  });
}
function normSeat(s){
  const t = String(s||'').trim();
  if(!t) return '';
  // "seat 8", "Seat8", "#8", "08" ë“± ëª¨ë‘ ì²˜ë¦¬
  const n = t.replace(/\s/g,'').replace(/^#?/,'').replace(/^seat/i, '').replace(/^0+/, '');
  return n ? '#'+n : '';
}

/* í”Œë ˆì´ì–´ ì¡°íšŒ í—¬í¼ í•¨ìˆ˜ */
function findPlayerBySeat(key, seat) {
  if (!key || !seat) return null;
  const arr = state.byRoomTable[key] || [];
  return arr.find(r => normSeat(r.seat) === normSeat(seat));
}

/* ===== UI ì±„ìš°ê¸° ===== */
function fillRoomTables(){
  const sel = document.getElementById('selRoomTable');
  sel.innerHTML = '<option value="">-</option>';

  // í‚¤ í”Œë ˆì´ì–´ ì •ë³´ë¥¼ í¬í•¨í•œ í…Œì´ë¸” ë¦¬ìŠ¤íŠ¸ ìƒì„±
  const tablesWithKeyPlayerInfo = state.tableList.map(t => {
    const playersAtTable = state.byRoomTable[t.key] || [];
    const hasKeyPlayer = playersAtTable.some(p => p.keyPlayer);
    return {
      ...t,
      hasKeyPlayer,
      keyPlayerIcon: hasKeyPlayer ? ' â­' : ''
    };
  });

  // í‚¤ í”Œë ˆì´ì–´ê°€ ìˆëŠ” í…Œì´ë¸”ì„ ìµœìƒë‹¨ì— ë°°ì¹˜
  const sortedTables = tablesWithKeyPlayerInfo.sort((a, b) => {
    if (a.hasKeyPlayer && !b.hasKeyPlayer) return -1;
    if (!a.hasKeyPlayer && b.hasKeyPlayer) return 1;
    return 0; // ê°™ì€ ê·¸ë£¹ ë‚´ì—ì„œëŠ” ì›ë˜ ìˆœì„œ ìœ ì§€
  });

  const fragment = document.createDocumentFragment();
  sortedTables.forEach(t => {
    const o = document.createElement('option');
    o.value = t.key;
    o.textContent = t.label + t.keyPlayerIcon;
    fragment.appendChild(o);
  });
  sel.appendChild(fragment);

  if (sel.options.length > 1) sel.selectedIndex = CONSTANTS.DEFAULT_SEAT_INDEX;
  fillSeats();
}

function fillSeats(){
  const key = document.getElementById('selRoomTable').value;
  const selSeat = document.getElementById('selSeat');
  const prevSeat = selSeat.value;

  selSeat.innerHTML = '<option value="">ì¢Œì„ ì„ íƒ</option>';

  if (!key) return;

  const arr = state.byRoomTable[key] || [];

  // Seat ë“œë¡­ë‹¤ìš´: "#1 - John Doe â­" í˜•ì‹ (KeyPlayer í‘œì‹œ)
  console.log(`ğŸ“‹ [fillSeats] í…Œì´ë¸” ${key}: ì „ì²´ ${arr.length}ëª…`);
  console.log(`ğŸ“‹ ì›ë³¸ ì¢Œì„:`, arr.map(r => r.seat));

  const seats = [...new Set(arr.map(r => normSeat(r.seat)))]
    .filter(s => s) // ë¹ˆ ê°’ ì œê±°
    .sort((a,b) => Number(a.replace('#','')) - Number(b.replace('#','')));

  console.log(`ğŸ“‹ ì •ê·œí™”ëœ ì¢Œì„ (${seats.length}ê°œ):`, seats);

  const fragment = document.createDocumentFragment();
  seats.forEach(s => {
    const player = findPlayerBySeat(key, s);
    const o = document.createElement('option');
    o.value = s;

    // ë””ë²„ê¹…: KeyPlayer í•„ë“œ í™•ì¸
    if (player) {
      console.log(`ğŸ¯ ì¢Œì„ ${s}:`, {
        player: player.player,
        keyPlayer: player.keyPlayer,
        rawData: player
      });
    }

    // KeyPlayerì¸ ê²½ìš° â­ í‘œì‹œ ì¶”ê°€
    const keyPlayerIcon = player?.keyPlayer ? ' â­' : '';
    o.textContent = `${s} - ${player?.player || ''}${keyPlayerIcon}`;

    fragment.appendChild(o);
  });
  selSeat.appendChild(fragment);

  const idx = seats.indexOf(prevSeat);
  selSeat.selectedIndex = idx >= 0 ? idx + CONSTANTS.DEFAULT_SEAT_INDEX : (seats.length > 0 ? CONSTANTS.DEFAULT_SEAT_INDEX : 0);

  applyPickFromSeat();
  rebuildFileName();
}

function applyPickFromSeat(){
  const key = document.getElementById('selRoomTable').value;
  const seat = document.getElementById('selSeat').value;
  const pick = findPlayerBySeat(key, seat);

  if (pick){
    document.getElementById('countryCode').value = pick.nat || '';
  }
  rebuildPreview();
  rebuildFileName();
}

/* ì‹œê°„ ì˜µì…˜ */
function fillTimes(list, center){
  const sel = document.getElementById('selTime');
  sel.innerHTML = '<option value="">(ë¯¸ì„ íƒ: í˜„ì¬ì‹œê°)</option>';

  const fragment = document.createDocumentFragment();
  list.forEach(v=>{
    const o=document.createElement('option');
    o.value=v; o.textContent = (v===center)? `${v}  â† í˜„ì¬` : v;
    fragment.appendChild(o);
  });
  sel.appendChild(fragment);
}

/* íŒŒì¼ëª… */
function hhmmFromTimeStr(t){ return (t||'').replace(':',''); }
function rebuildFileName(){
  const mode   = state.mode;
  const key    = document.getElementById('selRoomTable').value;
  const tno    = key ? key.split('|')[1] : '';
  const picked = document.getElementById('selTime').value;
  const hhmm   = hhmmFromTimeStr( picked || (state.timeCenter||'').slice(0,5) );

  let nameForMode;
  let modeData = {};

  if (mode === CONSTANTS.MODES.LEADERBOARD) {
    nameForMode = document.getElementById('lbTableLabel').value || ('Table'+tno);
  } else {
    const player = getSelectedPlayer();
    nameForMode = player ? player.player : 'Player';

    // PU ëª¨ë“œ: ì¹©ìˆ˜ + BB
    if (mode === CONSTANTS.MODES.PU) {
      const chipCount = parseIntClean(document.getElementById('stackAmt').value);
      const bb = document.getElementById('stackBB').value;
      modeData = { chipCount, bb };
    }

    // ELIM ëª¨ë“œ: ë¹ˆ ê°ì²´ (í•„ë“œ ì—†ìŒ)
    if (mode === CONSTANTS.MODES.ELIM) {
      modeData = {};
    }

    // L3 ëª¨ë“œ: í”„ë¡œí•„
    if (mode === CONSTANTS.MODES.L3) {
      modeData = { profileType: 'Profile' };
    }
  }

  // BATCH ëª¨ë“œ: ê°œìˆ˜
  if (state.batch.length > 0) {
    modeData.count = state.batch.length;
  }

  google.script.run.withSuccessHandler(name=>{
    document.getElementById('fileName').value = name;
  }).buildFileName(mode, hhmm, tno, nameForMode, modeData);
}

/* ìˆ«ì ìœ í‹¸ */
function parseIntClean(s){ const n = Number(String(s||'').replace(/[^0-9]/g,'')); return isNaN(n)?0:Math.round(n); }
function comma(n){ return Number(n||0).toLocaleString('en-US'); }

/* ë””ë°”ìš´ì‹± ìœ í‹¸ */
function debounce(func, delay) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => func(...args), delay);
  };
}

/* ì…ë ¥ì°½ ì‹¤ì‹œê°„ ì½¤ë§ˆ í¬ë§· */
function formatInputWithComma(el){
  const v = parseIntClean(el.value);
  el.value = v ? comma(v) : '';
}

/* PU: BB(ë°˜ì˜¬ë¦¼) */
function computeBB(){
  const amt = parseIntClean(document.getElementById('stackAmt').value);
  const bb  = parseIntClean(document.getElementById('bigBlind').value);
  const res = (amt>0 && bb>0) ? Math.round(amt / bb) : '';
  document.getElementById('stackBB').value = res || '';
  document.getElementById('stackBBView').value = res ? `${res}BB` : '';
}

/* ì„ íƒëœ í”Œë ˆì´ì–´ ì •ë³´ ê°€ì ¸ì˜¤ê¸° */
function getSelectedPlayer(){
  const key = document.getElementById('selRoomTable').value;
  const seat = document.getElementById('selSeat').value;
  return findPlayerBySeat(key, seat);
}

/* ===== ë°ì´í„° ì¬ë¡œë“œ (Stale-While-Revalidate) ===== */
function reloadSheets(){
  // Step 1: ë©”ëª¨ë¦¬ ìºì‹œê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ í‘œì‹œ (100ms)
  if (state.typeRows && state.typeRows.length > 0) {
    console.log('ğŸš€ [SWR] ë©”ëª¨ë¦¬ ìºì‹œ ì¦‰ì‹œ í‘œì‹œ:', state.typeRows.length, 'í–‰');
    indexTypeRows(state.typeRows);
    fillRoomTables();
    setStatus('ì¤€ë¹„ë¨ (ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹  ì¤‘...)');

    // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
    hideLoading();
  } else {
    // ìºì‹œ ì—†ìœ¼ë©´ ë¡œë”© í‘œì‹œ
    setStatus('ì‹œíŠ¸ ì •ë³´ ë¡œë”©â€¦');
    updateLoading('â° ì‹œê°„ ì˜µì…˜ ë¡œë“œ ì¤‘...', 'CUE Sheetì—ì„œ ì‹œê°„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  }

  // PC ë¡œì»¬ ì‹œê°„ ìƒì„± (HH:mm í˜•ì‹)
  const now = new Date();
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const clientTime = `${hours}:${minutes}`;

  // Step 2: ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìµœì‹  ë°ì´í„° ë¡œë“œ (ì‹œê°„ ì˜µì…˜)
  google.script.run.withSuccessHandler(res=>{
    if(res?.ok){
      state.timeCenter = res.center || '';
      fillTimes(res.list||[], res.center||'');
      rebuildFileName();

      if (!state.typeRows || state.typeRows.length === 0) {
        updateLoading('âœ… ì‹œê°„ ì˜µì…˜ ì™„ë£Œ', `${res.list?.length || 0}ê°œ ì‹œê°„ ì˜µì…˜ ë¡œë“œë¨`);
      }
    }
    else {
      toast('ì‹œê°„ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨: '+(res?.error||'unknown'), false);
    }
  }).getTimeOptions(state.cueId || null, clientTime);

  if (!state.typeRows || state.typeRows.length === 0) {
    updateLoading('ğŸ‘¥ í”Œë ˆì´ì–´ ì •ë³´ ë¡œë“œ ì¤‘...', 'TYPE Sheetì—ì„œ í”Œë ˆì´ì–´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  }

  // Step 3: ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìµœì‹  ë°ì´í„° ë¡œë“œ (í”Œë ˆì´ì–´ ì •ë³´ + ë²„ì „ ì²´í¬)
  const previousCount = state.typeRows?.length || 0;
  const hadCache = state.typeRows && state.typeRows.length > 0;

  google.script.run.withSuccessHandler(res=>{
    if(res?.ok){
      const newCount = res.rows?.length || 0;

      state.typeRows = res.rows||[];

      // ë””ë²„ê¹…: KeyPlayer ë°ì´í„° í™•ì¸
      console.log('ğŸ“Š Type íƒ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', res.rows?.length, 'í–‰');
      const keyPlayers = res.rows?.filter(r => r.keyPlayer) || [];
      console.log('â­ í‚¤ í”Œë ˆì´ì–´ ë°œê²¬:', keyPlayers.length, 'ëª…');
      keyPlayers.forEach(p => {
        console.log(`  - ${p.seat} ${p.player} (${p.room} Table ${p.tno})`);
      });

      // UI ì—…ë°ì´íŠ¸
      indexTypeRows(state.typeRows);
      fillRoomTables();

      // ë°ì´í„° ë³€ê²½ ê°ì§€
      if (hadCache && newCount !== previousCount) {
        console.log(`ğŸ”„ [SWR] ë°ì´í„° ë³€ê²½ ê°ì§€: ${previousCount}í–‰ â†’ ${newCount}í–‰`);
        toast(`ğŸ“Š í”Œë ˆì´ì–´ ì •ë³´ ì—…ë°ì´íŠ¸ë¨ (${newCount}ëª…, â­ ${keyPlayers.length}ëª…)`, true);
      } else if (hadCache) {
        console.log(`âœ… [SWR] ë°ì´í„° ë³€ê²½ ì—†ìŒ (${newCount}í–‰)`);
      }

      setStatus('ì¤€ë¹„ë¨');
    }
    else {
      toast('Type íƒ­ ë¡œë”© ì‹¤íŒ¨: '+(res?.error||'unknown'), false);
      setStatus('ì—ëŸ¬');
    }

    // ëª¨ë“  ë¡œë”© ì™„ë£Œ
    if (!hadCache || !state.typeRows || state.typeRows.length === 0) {
      setTimeout(() => {
        hideLoading();
      }, 500);
    }
  }).getCachedTypeRows(state.typeId || null);  // âœ… ë²„ì „ ì²´í¬ + 30ë¶„ ìºì‹±
}

  /* ë¯¸ë¦¬ë³´ê¸°(ì „ë¶€ ëŒ€ë¬¸ì ì¶œë ¥) */
function rebuildPreview(){
  const mode = state.mode;

  // DOM ìš”ì†Œ ìºì‹±
  const els = {
    stackAmt: document.getElementById('stackAmt'),
    stackBB: document.getElementById('stackBB'),
    preview: document.getElementById('preview')
  };

  let body='';

  if(mode===CONSTANTS.MODES.PU){
    computeBB();
    const player = getSelectedPlayer();
    if (!player) { body = ''; }
    else {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      const amt = (els.stackAmt.value||'').toUpperCase();
      const bb = (els.stackBB.value||'').toUpperCase();
      body = `${name} / ${country}\nCURRENT STACK - ${amt} (${bb}BB)`;
    }
  }else if(mode===CONSTANTS.MODES.ELIM){
    const player = getSelectedPlayer();
    if (!player) { body = ''; }
    else {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      body = `${name} / ${country}\nELIMINATED`;
    }
  }else if(mode===CONSTANTS.MODES.L3){
    const player = getSelectedPlayer();
    if (!player) { body = ''; }
    else {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      body = `í”Œë ˆì´ì–´ ì†Œê°œ\n${name} / ${country}`;
    }
  }
  els.preview.value = body;
}

// í˜„ì¬ ì…ë ¥ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
function generateCurrentPreview() {
  const mode = state.mode;
  const els = {
    stackAmt: document.getElementById('stackAmt'),
    stackBB: document.getElementById('stackBB')
  };

  let body = '';

  if (mode === CONSTANTS.MODES.PU) {
    computeBB();
    const player = getSelectedPlayer();
    if (player) {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      const amt = (els.stackAmt.value || '').toUpperCase();
      const bb = (els.stackBB.value || '').toUpperCase();
      body = `${name} / ${country}\nCURRENT STACK - ${amt} (${bb}BB)`;
    }
  } else if (mode === CONSTANTS.MODES.ELIM) {
    const player = getSelectedPlayer();
    if (player) {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      body = `${name} / ${country}\nELIMINATED`;
    }
  } else if (mode === CONSTANTS.MODES.L3) {
    const player = getSelectedPlayer();
    if (player) {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      body = `í”Œë ˆì´ì–´ ì†Œê°œ\n${name} / ${country}`;
    }
  }

  return body;
}

// ë¯¸ë¦¬ë³´ê¸° í†µí•© ì—…ë°ì´íŠ¸
function updateBatchPreview() {
  const previewEl = document.getElementById('preview');
  const previewLabel = document.getElementById('previewLabel');

  if (state.batch.length > 0) {
    // ë°°ì¹˜ ëª¨ë“œ: ë°°ì¹˜ ì „ì²´ ë‚´ìš© + í˜„ì¬ ì…ë ¥ í‘œì‹œ
    const batchContent = state.batch.map(item => item.content).join('\n\n');
    const currentPreview = generateCurrentPreview();

    previewLabel.textContent = `ë¯¸ë¦¬ë³´ê¸° (ë°°ì¹˜ ${state.batch.length}ê±´ + í˜„ì¬ ì…ë ¥)`;
    previewEl.value = `=== ë°°ì¹˜ ì „ì†¡ë  ë‚´ìš© (${state.batch.length}ê±´) ===\n\n${batchContent}\n\n=== í˜„ì¬ ì…ë ¥ (ë°°ì¹˜ì— ì¶”ê°€í•˜ë ¤ë©´ [â• ë°°ì¹˜ì— ì¶”ê°€] í´ë¦­) ===\n\n${currentPreview}`;
  } else {
    // ë‹¨ì¼ ëª¨ë“œ
    previewLabel.textContent = 'ë¯¸ë¦¬ë³´ê¸°';
    rebuildPreview();
  }
}

  // ===== Optimistic UI: IndexedDB ë™ê¸°í™” í =====
// ëª©ì : ì¦‰ì‹œ UI í”¼ë“œë°± + ë°±ê·¸ë¼ìš´ë“œ Sheets ë™ê¸°í™”

const SYNC_DB_NAME = 'SoftSenderQueue';
const SYNC_DB_VERSION = 1;
const SYNC_STORE_NAME = 'queue';

// IndexedDB ì´ˆê¸°í™”
async function initSyncDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(SYNC_DB_NAME, SYNC_DB_VERSION);

    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve(request.result);

    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(SYNC_STORE_NAME)) {
        const store = db.createObjectStore(SYNC_STORE_NAME, { keyPath: 'id' });
        store.createIndex('status', 'status', { unique: false });
        store.createIndex('timestamp', 'timestamp', { unique: false });
        console.log('âœ… IndexedDB ë™ê¸°í™” í ìƒì„± ì™„ë£Œ');
      }
    };
  });
}

// ë™ê¸°í™” íì— ì¶”ê°€
async function addToSyncQueue(item) {
  const db = await initSyncDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(SYNC_STORE_NAME, 'readwrite');
    const store = tx.objectStore(SYNC_STORE_NAME);
    const request = store.put(item);

    request.onsuccess = () => {
      console.log(`âœ… í ì¶”ê°€: ID=${item.id}, ìƒíƒœ=${item.status}`);
      resolve(item.id);
    };
    request.onerror = () => reject(request.error);
  });
}

// ë™ê¸°í™” í ì—…ë°ì´íŠ¸
async function updateSyncQueue(id, status, result = null) {
  const db = await initSyncDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(SYNC_STORE_NAME, 'readwrite');
    const store = tx.objectStore(SYNC_STORE_NAME);
    const getRequest = store.get(id);

    getRequest.onsuccess = () => {
      const item = getRequest.result;
      if (item) {
        item.status = status;
        item.result = result;
        item.updatedAt = Date.now();

        const putRequest = store.put(item);
        putRequest.onsuccess = () => {
          console.log(`âœ… í ì—…ë°ì´íŠ¸: ID=${id}, ìƒíƒœ=${status}`);
          resolve();
        };
        putRequest.onerror = () => reject(putRequest.error);
      } else {
        reject(new Error(`Item not found: ${id}`));
      }
    };
    getRequest.onerror = () => reject(getRequest.error);
  });
}

// ë™ê¸°í™” í ì¡°íšŒ (ë‹¨ì¼)
async function getSyncQueueItem(id) {
  const db = await initSyncDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(SYNC_STORE_NAME, 'readonly');
    const store = tx.objectStore(SYNC_STORE_NAME);
    const request = store.get(id);

    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// ë™ê¸°í™” í ì „ì²´ ì¡°íšŒ
async function getAllSyncQueue() {
  const db = await initSyncDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(SYNC_STORE_NAME, 'readonly');
    const store = tx.objectStore(SYNC_STORE_NAME);
    const request = store.getAll();

    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// ì‹¤íŒ¨í•œ í•­ëª© ì¡°íšŒ
async function getFailedSyncItems() {
  const db = await initSyncDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(SYNC_STORE_NAME, 'readonly');
    const store = tx.objectStore(SYNC_STORE_NAME);
    const index = store.index('status');
    const request = index.getAll('failed');

    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// ë™ê¸°í™” í ì‚­ì œ
async function removeSyncQueueItem(id) {
  const db = await initSyncDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(SYNC_STORE_NAME, 'readwrite');
    const store = tx.objectStore(SYNC_STORE_NAME);
    const request = store.delete(id);

    request.onsuccess = () => {
      console.log(`âœ… í ì‚­ì œ: ID=${id}`);
      resolve();
    };
    request.onerror = () => reject(request.error);
  });
}

// ì˜¤ë˜ëœ í•­ëª© ì •ë¦¬ (24ì‹œê°„ ì´ìƒ)
async function cleanupOldSyncQueue() {
  const items = await getAllSyncQueue();
  const now = Date.now();
  const cutoff = 24 * 60 * 60 * 1000; // 24ì‹œê°„

  for (const item of items) {
    if (item.status === 'success' && (now - item.timestamp > cutoff)) {
      await removeSyncQueueItem(item.id);
    }
  }

  console.log('âœ… ë™ê¸°í™” í ì •ë¦¬ ì™„ë£Œ');
}

// ì•± ì‹œì‘ ì‹œ ì´ˆê¸°í™”
(async function() {
  try {
    await initSyncDB();
    await cleanupOldSyncQueue();
    console.log('âœ… ë™ê¸°í™” ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
  } catch(e) {
    console.error('âŒ ë™ê¸°í™” ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
  }
})();

  // ===== Optimistic UI: ì¦‰ì‹œ í”¼ë“œë°± + ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™” =====

// ì¬ì‹œë„ ì„¤ì •
const RETRY_MAX_ATTEMPTS = 3;
const RETRY_BASE_DELAY = 2000; // 2ì´ˆ

// Optimistic UIë¡œ ì „ì†¡ (ì¦‰ì‹œ í”¼ë“œë°±)
async function sendWithOptimisticUI(payload) {
  const tempId = Date.now();

  try {
    // 1. ì¦‰ì‹œ UI í”¼ë“œë°± (0.1ì´ˆ ì´ë‚´)
    toast('âœ… ì „ì†¡ ì¤‘...', true);
    showLoading('ì„œë²„ ì „ì†¡ ì¤‘...', 'ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”');

    // 2. ë¡œì»¬ íì— ì¶”ê°€
    await addToSyncQueue({
      id: tempId,
      payload: payload,
      status: 'pending',
      timestamp: Date.now(),
      attempts: 0
    });

    // 3. ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™” ì‹œì‘
    syncToServer(tempId, payload);

    // 4. ì¦‰ì‹œ ë‹¤ìŒ ì‘ì—… í—ˆìš© (ì‚¬ìš©ìëŠ” ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
    setTimeout(() => {
      hideLoading();
      toast('ğŸ“¤ ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™” ì¤‘...', true);
    }, 300);

  } catch(e) {
    console.error('âŒ Optimistic UI ì‹¤íŒ¨:', e);
    hideLoading();
    toast('âŒ ì „ì†¡ ì‹¤íŒ¨ - ì¬ì‹œë„í•˜ì„¸ìš”', false);
  }
}

// ì„œë²„ ë™ê¸°í™” (ë¹„ë™ê¸°)
function syncToServer(id, payload, attempt = 1) {
  console.log(`ğŸ”„ ì„œë²„ ë™ê¸°í™” ì‹œì‘: ID=${id}, ì‹œë„=${attempt}/${RETRY_MAX_ATTEMPTS}`);

  google.script.run
    .withSuccessHandler(async (res) => {
      if (res.ok) {
        // ì„±ê³µ - ì§„í–‰ ë¡œê·¸ í‘œì‹œ
        if (res.logs && res.logs.length > 0) {
          console.log('ğŸ“‹ [ì„œë²„ ì§„í–‰ ë¡œê·¸]:');
          res.logs.forEach(log => {
            console.log(`  ${log.step} ${log.message}${log.duration ? ` (${log.duration}ms)` : ''}`);
          });
        }

        await updateSyncQueue(id, 'success', res);
        console.log(`âœ… ë™ê¸°í™” ì„±ê³µ: ${res.filename} (ì´ ${(res.totalTime/1000).toFixed(1)}ì´ˆ)`);
        toast(`âœ… ì €ì¥ ì™„ë£Œ: ${res.filename} (${(res.totalTime/1000).toFixed(1)}ì´ˆ)`, true);

        // ì„±ê³µí•œ í•­ëª©ì€ 10ì´ˆ í›„ ì‚­ì œ
        setTimeout(() => removeSyncQueueItem(id), 10000);
      } else {
        // ì„œë²„ ì—ëŸ¬ - ì—ëŸ¬ ë¡œê·¸ë„ í‘œì‹œ
        if (res.logs && res.logs.length > 0) {
          console.log('ğŸ“‹ [ì„œë²„ ì§„í–‰ ë¡œê·¸ (ì—ëŸ¬ ë°œìƒ)]:');
          res.logs.forEach(log => {
            console.log(`  ${log.step} ${log.message}${log.duration ? ` (${log.duration}ms)` : ''}`);
          });
        }

        console.error(`âš ï¸ ì„œë²„ ì—ëŸ¬: ${res.error}`);
        await handleSyncFailure(id, payload, attempt, res.error);
      }
    })
    .withFailureHandler(async (err) => {
      // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬
      console.error(`âŒ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬:`, err);
      await handleSyncFailure(id, payload, attempt, String(err));
    })
    .updateVirtual(payload);
}

// ë™ê¸°í™” ì‹¤íŒ¨ ì²˜ë¦¬
async function handleSyncFailure(id, payload, attempt, errorMsg) {
  if (attempt < RETRY_MAX_ATTEMPTS) {
    // ì¬ì‹œë„
    await updateSyncQueue(id, 'retrying', { attempt, error: errorMsg });

    const delay = RETRY_BASE_DELAY * Math.pow(2, attempt - 1); // ì§€ìˆ˜ ë°±ì˜¤í”„
    console.log(`ğŸ”„ ${delay/1000}ì´ˆ í›„ ì¬ì‹œë„ (${attempt + 1}/${RETRY_MAX_ATTEMPTS})`);

    toast(`ğŸ”„ ì¬ì‹œë„ ${attempt}/${RETRY_MAX_ATTEMPTS} ëŒ€ê¸° ì¤‘...`, true);

    setTimeout(() => {
      syncToServer(id, payload, attempt + 1);
    }, delay);
  } else {
    // ìµœì¢… ì‹¤íŒ¨
    await updateSyncQueue(id, 'failed', {
      attempt,
      error: errorMsg,
      finalError: 'ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼'
    });

    console.error(`âŒ ìµœì¢… ì‹¤íŒ¨: ID=${id}`);
    toast(`âŒ ì „ì†¡ ì‹¤íŒ¨ (ID: ${id}) - ìˆ˜ë™ ì¬ì „ì†¡ í•„ìš”`, false);

    // ì‹¤íŒ¨ ì•Œë¦¼ UI í‘œì‹œ
    showFailedSyncNotification(id, payload);
  }
}

// ì‹¤íŒ¨í•œ ë™ê¸°í™” ì•Œë¦¼ UI
function showFailedSyncNotification(id, payload) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--error-bg);
    color: var(--error-color);
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10000;
    max-width: 90%;
    text-align: center;
  `;

  notification.innerHTML = `
    <div style="margin-bottom: 8px;">
      âš ï¸ ì „ì†¡ ì‹¤íŒ¨ (ID: ${id})
    </div>
    <button onclick="retrySyncManually(${id})" style="
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 8px;
    ">
      ğŸ”„ ì¬ì‹œë„
    </button>
    <button onclick="dismissFailedSync(${id}, this.parentElement.parentElement)" style="
      background: #666;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    ">
      ë¬´ì‹œ
    </button>
  `;

  document.body.appendChild(notification);

  // 30ì´ˆ í›„ ìë™ ì œê±°
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, 30000);
}

// ìˆ˜ë™ ì¬ì‹œë„
window.retrySyncManually = async function(id) {
  const item = await getSyncQueueItem(id);
  if (item) {
    toast('ğŸ”„ ì¬ì‹œë„ ì¤‘...', true);
    syncToServer(id, item.payload, 1);
  } else {
    toast('âŒ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', false);
  }
};

// ì‹¤íŒ¨ ì•Œë¦¼ ë¬´ì‹œ
window.dismissFailedSync = async function(id, element) {
  await removeSyncQueueItem(id);
  element.remove();
  toast('ì•Œë¦¼ ì œê±°ë¨', true);
};

// ì•± ì‹œì‘ ì‹œ ì‹¤íŒ¨í•œ í•­ëª© ë³µêµ¬
(async function() {
  try {
    const failedItems = await getFailedSyncItems();
    if (failedItems.length > 0) {
      console.log(`âš ï¸ ì‹¤íŒ¨í•œ ë™ê¸°í™” ${failedItems.length}ê±´ ë°œê²¬`);

      // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
      toast(`âš ï¸ ì‹¤íŒ¨í•œ ì „ì†¡ ${failedItems.length}ê±´ - ì¬ì‹œë„ ê°€ëŠ¥`, false);

      // ê° ì‹¤íŒ¨ í•­ëª©ì— ëŒ€í•œ ì•Œë¦¼ í‘œì‹œ
      failedItems.forEach(item => {
        showFailedSyncNotification(item.id, item.payload);
      });
    }
  } catch(e) {
    console.error('âŒ ì‹¤íŒ¨ í•­ëª© ë³µêµ¬ ì‹¤íŒ¨:', e);
  }
})();

  /* ===== ë°°ì¹˜ ë¹Œë” (ìŠ¤ë§ˆíŠ¸ í†µí•©) ===== */

// ìŠ¤ë§ˆíŠ¸ ì „ì†¡ ë²„íŠ¼ ì—…ë°ì´íŠ¸
function updateSendButton() {
  const btnSend = document.getElementById('btnSend');
  const btnAddToBatch = document.getElementById('btnAddToBatch');
  const batchSection = document.getElementById('batchSection');

  if (state.batch.length > 0) {
    // ë°°ì¹˜ ëª¨ë“œ
    btnSend.innerHTML = `ğŸ“¤ ë°°ì¹˜ ì „ì†¡ (${state.batch.length}ê±´)`;
    batchSection.style.display = 'block';
  } else {
    // ë‹¨ì¼ ëª¨ë“œ
    btnSend.innerHTML = 'ì „ì†¡';
    batchSection.style.display = 'none';
  }

  // ë°°ì¹˜ ì¶”ê°€ ë²„íŠ¼ í•­ìƒ í‘œì‹œ
  btnAddToBatch.style.display = 'block';
}

// ë°°ì¹˜ì— ì¶”ê°€
function addToBatch() {
  const preview = document.getElementById('preview').value.trim();

  if (!preview) {
    toast('ë¯¸ë¦¬ë³´ê¸°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë¨¼ì € í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ê³  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', false);
    return;
  }

  const player = getSelectedPlayer();
  const mode = state.mode;

  state.batch.push({
    mode,
    player: player?.player || 'Unknown',
    seat: player?.seat || '',
    nat: player?.nat || '',
    keyPlayer: player?.keyPlayer || false,
    content: preview
  });

  renderBatchList();
  updateBatchPreview();
  updateSendButton();
  toast(`âœ… ë°°ì¹˜ì— ì¶”ê°€ë¨ (${state.batch.length}ê±´)`, true);

  moveToNextSeat();
}

// ë°°ì¹˜ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function renderBatchList() {
  const list = document.getElementById('batchList');

  if (state.batch.length === 0) {
    list.innerHTML = '';
    document.getElementById('batchCount').textContent = '0';
    return;
  }

  list.innerHTML = '';

  state.batch.forEach((item, idx) => {
    const div = document.createElement('div');
    div.style.cssText = 'background:var(--panel); padding:14px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; min-height:44px;';

    const keyPlayerIcon = item.keyPlayer ? ' â­' : '';

    div.innerHTML = `
      <div style="flex:1; min-width:0;">
        <div style="font-weight:600; font-size:0.95em;">
          ${idx + 1}. ${item.seat} ${item.player}${keyPlayerIcon}
          <span style="color:var(--accent); margin-left:8px; font-size:0.85em;">[${item.mode}]</span>
        </div>
        <div class="muted" style="font-size:0.8em; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          ${item.content.replace(/\n/g, ' Â· ').substring(0, 60)}...
        </div>
      </div>
      <button class="btn ghost" data-idx="${idx}" style="padding:10px 16px; height:auto; font-size:0.85em; margin-left:10px; flex-shrink:0;">
        ì‚­ì œ
      </button>
    `;

    div.querySelector('button').addEventListener('click', (e) => {
      const idx = parseInt(e.target.dataset.idx);
      state.batch.splice(idx, 1);
      renderBatchList();
      updateBatchPreview();
      updateSendButton();
      toast('í•­ëª© ì‚­ì œë¨', true);
    });

    list.appendChild(div);
  });

  document.getElementById('batchCount').textContent = state.batch.length;
}

// ë‹¤ìŒ ì¢Œì„ìœ¼ë¡œ ìë™ ì´ë™
function moveToNextSeat() {
  const key = document.getElementById('selRoomTable').value;
  const seat = document.getElementById('selSeat').value;
  const arr = state.byRoomTable[key] || [];

  const seats = [...new Set(arr.map(r => normSeat(r.seat)))]
    .sort((a,b) => Number(a.replace('#','')) - Number(b.replace('#','')));

  const currentIndex = seats.indexOf(seat);

  if (currentIndex >= 0 && currentIndex < seats.length - 1) {
    const nextSeat = seats[currentIndex + 1];
    document.getElementById('selSeat').value = nextSeat;
    applyPickFromSeat();
    rebuildPreview();
    rebuildFileName();
  } else {
    if (seats.length > 0) {
      document.getElementById('selSeat').value = seats[0];
      applyPickFromSeat();
      rebuildPreview();
      rebuildFileName();
    }
  }
}

// ë°°ì¹˜ ì „ì†¡
function sendBatch() {
  if (state.batch.length === 0) {
    toast('ë°°ì¹˜ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.', false);
    return;
  }

  const jBlock = state.batch.map(item => item.content).join('\n\n');

  const autoNow = document.getElementById('chkAuto').checked;
  const picked = document.getElementById('selTime').value;

  // PC ë¡œì»¬ ì‹œê°„ ì‚¬ìš© (autoNowì¼ ë•Œ)
  let timeStr, hhmm;
  if (autoNow) {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    timeStr = `${hours}:${minutes}`;
    hhmm = `${hours}${minutes}`;
  } else {
    timeStr = picked;
    hhmm = hhmmFromTimeStr(timeStr);
  }

  const key = document.getElementById('selRoomTable').value;
  const tno = key ? key.split('|')[1] : '';

  // ë°°ì¹˜ íŒŒì¼ëª… ìƒì„± ë°ì´í„°
  const modeData = { count: state.batch.length };

  const payload = {
    autoNow,
    pickedTime: picked,
    tz: state.tz,
    kind: 'BATCH',
    eFix: 'ë¯¸ì™„ë£Œ',
    gFix: 'SOFT',
    playerName: 'Batch',
    tableNo: tno,
    hhmm,
    modeData,
    jBlock,
    cueId: state.cueId || undefined
  };

  // ë¡œë”© ì‹œì‘
  if (!LoadingManager.start('SEND_BATCH', 'ë°°ì¹˜ ì „ì†¡ ì¤‘...', `${state.batch.length}ê±´ ë°ì´í„°ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤...`)) {
    return;
  }

  google.script.run
    .withSuccessHandler(res => {
      if (!res?.ok) {
        LoadingManager.error('ì „ì†¡ ì‹¤íŒ¨: ' + (res?.error || 'unknown'));
        return;
      }

      LoadingManager.success(`âœ… ${res.filename} - í–‰ ${res.row}(${res.time}) ì €ì¥ ì™„ë£Œ (${state.batch.length}ê±´, SC${String(res.scNumber).padStart(3, '0')})`);

      state.batch = [];
      renderBatchList();
      updateBatchPreview();
      updateSendButton();
    })
    .withFailureHandler(err => {
      LoadingManager.error('ì„œë²„ ì˜¤ë¥˜: ' + (err?.message || err));
    })
    .updateVirtual(payload);
}

/* ìŠ¤ë§ˆíŠ¸ ì „ì†¡ (ë‹¨ì¼/ë°°ì¹˜ ìë™ ê°ì§€) */
function send(){
  // ë°°ì¹˜ ëª¨ë“œì¸ì§€ í™•ì¸
  if (state.batch.length > 0) {
    sendBatch();
    return;
  }

  // ë‹¨ì¼ ì „ì†¡
  sendSingle();
}

// ë‹¨ì¼ ì „ì†¡
function sendSingle() {
  const autoNow = document.getElementById('chkAuto').checked;
  const picked  = document.getElementById('selTime').value;
  const jBlock  = generateCurrentPreview(); // ë°°ì¹˜ ë¯¸ë¦¬ë³´ê¸° ì œì™¸

  if(!jBlock){ toast('ë¯¸ë¦¬ë³´ê¸° ë‚´ìš©ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.', false); return; }
  if(state.mode===CONSTANTS.MODES.PU){
    if(!parseIntClean(document.getElementById('stackAmt').value) || !parseIntClean(document.getElementById('bigBlind').value)){
      toast('ì¹©ìŠ¤íƒ/ë¹…ë¸”ì„ ì…ë ¥í•˜ì„¸ìš”.', false); return;
    }
  }

  // íŒŒì¼ëª… ìƒì„±ì— í•„ìš”í•œ ë°ì´í„° ìˆ˜ì§‘
  const player = getSelectedPlayer();
  const key = document.getElementById('selRoomTable').value;
  const tno = key ? key.split('|')[1] : '';

  // PC ë¡œì»¬ ì‹œê°„ ì‚¬ìš© (autoNowì¼ ë•Œ)
  let timeStr, hhmm;
  if (autoNow) {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    timeStr = `${hours}:${minutes}`;
    hhmm = `${hours}${minutes}`;
  } else {
    timeStr = picked;
    hhmm = hhmmFromTimeStr(timeStr);
  }

  let modeData = {};
  if (state.mode === CONSTANTS.MODES.PU) {
    const chipCount = parseIntClean(document.getElementById('stackAmt').value);
    const bb = document.getElementById('stackBB').value;
    modeData = { chipCount, bb };
  } else if (state.mode === CONSTANTS.MODES.ELIM) {
    modeData = {};
  } else if (state.mode === CONSTANTS.MODES.L3) {
    modeData = { profileType: 'Profile' };
  }

  // ===== Optimistic UI ì ìš©: ì¦‰ì‹œ í”¼ë“œë°± =====
  const payload = {
    autoNow,
    pickedTime: picked,
    tz: state.tz,
    kind: state.mode,
    eFix: 'ë¯¸ì™„ë£Œ',
    gFix: 'SOFT',
    playerName: player ? player.player : 'Player',
    tableNo: tno,
    hhmm,
    modeData,
    jBlock,
    cueId: state.cueId || undefined
  };

  // ë¡œë”© ì‹œì‘
  if (!LoadingManager.start('SEND_SINGLE', 'ë‹¨ì¼ ì „ì†¡ ì¤‘...', `${payload.playerName} ë°ì´í„°ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤...`)) {
    return;
  }

  google.script.run.withSuccessHandler(res=>{
    if(!res?.ok){
      LoadingManager.error('ì „ì†¡ ì‹¤íŒ¨: '+(res?.error||'unknown'));
      return;
    }
    LoadingManager.success(`âœ… ${res.filename} - í–‰ ${res.row}(${res.time}) ì €ì¥ ì™„ë£Œ (SC${String(res.scNumber).padStart(3, '0')})`);
  }).withFailureHandler(err=>{
    LoadingManager.error('ì„œë²„ ì˜¤ë¥˜: '+(err?.message||err));
  }).updateVirtual(payload);
}

  // ëª¨ë“œ ë³€ê²½
function setMode(m){
  state.mode = m;
  document.getElementById('tabPU').classList.toggle('active', m===CONSTANTS.MODES.PU);
  document.getElementById('tabELIM').classList.toggle('active', m===CONSTANTS.MODES.ELIM);
  document.getElementById('tabL3').classList.toggle('active', m===CONSTANTS.MODES.L3);

  document.getElementById('panelPU').style.display   = (m===CONSTANTS.MODES.PU)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;
  document.getElementById('panelELIM').style.display = (m===CONSTANTS.MODES.ELIM)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;
  document.getElementById('panelL3').style.display   = (m===CONSTANTS.MODES.L3)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;

  // ë°°ì¹˜ ì‘ì—… ì¤‘ ëª¨ë“œ ë³€ê²½ ì‹œ í”¼ë“œë°±
  if (state.batch.length > 0) {
    const modeNames = {
      PU: 'í”Œë ˆì´ì–´ ì—…ë°ì´íŠ¸',
      ELIM: 'í”Œë ˆì´ì–´ íƒˆë½',
      L3: 'í”Œë ˆì´ì–´ ì†Œê°œ'
    };
    toast(`âš ï¸ ëª¨ë“œ ë³€ê²½: ${modeNames[m]}`, true);
  }

  rebuildPreview();
  rebuildFileName();
  updateSendButton();  // ëª¨ë“œ ë³€ê²½ ì‹œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
}

  // ì „ì—­ ë³€ìˆ˜: setInterval ID ì €ì¥ (ì¤‘ë³µ ë°©ì§€)
let keepAliveInterval = null;
let isInitialized = false;

function init(){
  // ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€
  if (isInitialized) {
    console.warn('âš ï¸ init() ì´ë¯¸ ì‹¤í–‰ë¨ - ì¤‘ë³µ í˜¸ì¶œ ì°¨ë‹¨');
    return;
  }
  isInitialized = true;

  // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
  showLoading('ğŸ”§ ì´ˆê¸°í™” ì¤‘...', 'ì„œë²„ ì—°ê²° ì¤‘...');

  // ì„œë²„ì—ì„œ ë¶€íŠ¸ìŠ¤íŠ¸ë© ì •ë³´ ë¡œë“œ (ì‚¬ìš©ìë³„ ì €ì¥ëœ Sheet ID í¬í•¨)
  google.script.run.withSuccessHandler(info=>{
    updateLoading('âœ… ì„œë²„ ì—°ê²° ì™„ë£Œ', `ì‚¬ìš©ì: ${info?.userEmail || 'Anonymous'}`);

    state.tz = info?.tz || 'Asia/Seoul';

    // ì„œë²„ì—ì„œ ë¡œë“œí•œ Sheet IDë¥¼ ì…ë ¥ í•„ë“œì— ì„¤ì •
    const serverCueId = info?.cueId || '';
    const serverTypeId = info?.typeId || '';

    updateLoading('ğŸ“¥ ì„¤ì • ë¡œë“œ ì¤‘...', `CUE ID: ${serverCueId ? 'ì‚¬ìš©ì ì„¤ì •' : 'ê¸°ë³¸ê°’'}\nTYPE ID: ${serverTypeId ? 'ì‚¬ìš©ì ì„¤ì •' : 'ê¸°ë³¸ê°’'}`);

    if (serverCueId) {
      document.getElementById('cueId').value = serverCueId;
      localStorage.setItem(LS_KEYS.CUE, serverCueId);
    }
    if (serverTypeId) {
      document.getElementById('typeId').value = serverTypeId;
      localStorage.setItem(LS_KEYS.TYPE, serverTypeId);
    }

    state.cueId = serverCueId;
    state.typeId = serverTypeId;
    renderIdsHint();

    document.getElementById('footerInfo').textContent =
      `ë¡œê·¸ì¸: ${info?.userEmail || 'Anonymous'}  |  ê¸°ë³¸ CUE: ${info?.defaultCueId?.substring(0, 8)}...  |  TZ=${state.tz}`;

    updateLoading('ğŸ“Š ë°ì´í„° ë¡œë“œ ì¤‘...', 'ì‹œê°„ ì˜µì…˜ & í”Œë ˆì´ì–´ ì •ë³´ ë¡œë”©...');

    // Sheet ID ë¡œë“œ í›„ ë°ì´í„° ë¡œë“œ
    reloadSheets();
  }).withFailureHandler(err => {
    hideLoading();
    toast('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + (err?.message || err), false);
    setStatus('ì—ëŸ¬');
  }).getBootstrap();

  // localStorageì—ì„œ ì„ì‹œ ë¡œë“œ (ì„œë²„ ì‘ë‹µ ì „ ë¹ ë¥¸ í‘œì‹œìš©)
  loadIdsFromLocal();

  document.getElementById('btnSaveIds').onclick = saveIds;
  document.getElementById('btnClearIds').onclick = clearIds;

  // Sheet ID ì…ë ¥ í•„ë“œ ìë™ ì €ì¥ (debounce ì ìš©)
  const debouncedAutoSave = debounce(autoSaveIds, 1000); // 1ì´ˆ ëŒ€ê¸° í›„ ì €ì¥
  document.getElementById('cueId').addEventListener('input', debouncedAutoSave);
  document.getElementById('typeId').addEventListener('input', debouncedAutoSave);

  document.getElementById('tabPU').onclick   = ()=>setMode(CONSTANTS.MODES.PU);
  document.getElementById('tabELIM').onclick = ()=>setMode(CONSTANTS.MODES.ELIM);
  document.getElementById('tabL3').onclick   = ()=>setMode(CONSTANTS.MODES.L3);
  document.getElementById('btnSend').onclick = send;

  // ë°°ì¹˜ ì¶”ê°€ ë²„íŠ¼
  document.getElementById('btnAddToBatch').addEventListener('click', addToBatch);

  // ë°°ì¹˜ ì „ì²´ ì‚­ì œ
  document.getElementById('btnClearBatch').addEventListener('click', () => {
    if (state.batch.length === 0) return;

    if (confirm(`${state.batch.length}ê°œ í•­ëª©ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      state.batch = [];
      renderBatchList();
      updateBatchPreview();
      updateSendButton();
      toast('ë°°ì¹˜ ì´ˆê¸°í™”ë¨', true);
    }
  });

  // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤: Ctrl+B
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
      e.preventDefault();
      if (state.batch.length > 0 || document.getElementById('btnAddToBatch').style.display !== 'none') {
        addToBatch();
      }
    }
  });

  document.getElementById('selRoomTable').addEventListener('change', fillSeats);
  document.getElementById('selSeat').addEventListener('change', applyPickFromSeat);

  // ë””ë°”ìš´ì‹±ëœ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
  const debouncedRebuild = debounce(() => {
    rebuildPreview();
    rebuildFileName();
  }, CONSTANTS.DEBOUNCE_DELAY);

  const stackAmt = document.getElementById('stackAmt');
  stackAmt.addEventListener('input', ()=>{ formatInputWithComma(stackAmt); computeBB(); debouncedRebuild(); });
  const bigBlind = document.getElementById('bigBlind');
  bigBlind.addEventListener('input', ()=>{ formatInputWithComma(bigBlind); computeBB(); debouncedRebuild(); });

  setMode(CONSTANTS.MODES.PU);

  // Priority 1: Session Keep-Alive (Cold Start ì œê±°)
  startSessionKeepAlive();
}

// ì„¸ì…˜ ìœ ì§€ í•¨ìˆ˜ (4ë¶„ë§ˆë‹¤ ë”ë¯¸ í˜¸ì¶œ)
function startSessionKeepAlive() {
  // ê¸°ì¡´ interval ì •ë¦¬ (ì¤‘ë³µ ë°©ì§€)
  if (keepAliveInterval) {
    console.log('ğŸ§¹ [Keep-Alive] ê¸°ì¡´ interval ì •ë¦¬');
    clearInterval(keepAliveInterval);
    keepAliveInterval = null;
  }

  console.log('ğŸ”„ [Keep-Alive] ì„¸ì…˜ ìœ ì§€ ì‹œì‘');

  keepAliveInterval = setInterval(() => {
    const timestamp = new Date().toLocaleTimeString('ko-KR');
    console.log(`ğŸ”„ [Keep-Alive] ì„¸ì…˜ ìœ ì§€ ì¤‘... (${timestamp})`);

    google.script.run
      .withSuccessHandler(() => {
        console.log(`âœ… [Keep-Alive] ì„¸ì…˜ ìœ ì§€ ì„±ê³µ (${timestamp})`);
      })
      .withFailureHandler((err) => {
        console.warn(`âš ï¸ [Keep-Alive] ì„¸ì…˜ ìœ ì§€ ì‹¤íŒ¨: ${err}`);
      })
      .getBootstrap(); // ê°€ë²¼ìš´ í•¨ìˆ˜ í˜¸ì¶œ
  }, 4 * 60 * 1000); // 4ë¶„ë§ˆë‹¤ (Google 5ë¶„ íƒ€ì„ì•„ì›ƒ ì „)
}

// í˜ì´ì§€ ì¢…ë£Œ ì‹œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
window.addEventListener('beforeunload', () => {
  if (keepAliveInterval) {
    console.log('ğŸ§¹ [Clean-Up] Keep-Alive interval ì •ë¦¬');
    clearInterval(keepAliveInterval);
    keepAliveInterval = null;
  }
});

window.addEventListener('load', init);

</script>
</body>
</html>
