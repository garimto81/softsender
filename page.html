<!--
  Soft Content Sender v10.1
  Build Time: 2025-10-04T16:57:24.881Z
  Build Mode: NORMAL

  âš ï¸  AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY
  Edit source files in src/ and run 'npm run build'
-->

<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
:root{
  --bg:#0E0F10; --panel:#141516; --panel2:#1B1C1D; --border:#2A2B2C;
  --txt:#F2F3F5; --sub:#B9C0CC; --accent:#19D27C; --err:#FF6464;
  --radius:16px; --pad:18px;

  --fs-base:24px; --fs-sm:19px; --fs-h:32px; --touch:64px;
}
html,body{background:var(--bg); color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; font-size:var(--fs-base); margin:0;}
.wrap{max-width:980px;margin:0 auto;padding:14px 14px 120px;}
header{display:flex;justify-content:space-between;align-items:flex-end;margin:8px 0 12px;}
h1{font-size:var(--fs-h);margin:8px 0;}
#status{font-size:var(--fs-sm);color:#9fe7cc;}

.field{margin:14px 0;}
label{display:block;margin:6px 0 8px;color:var(--sub);font-size:var(--fs-sm);}
input,select,textarea{
  width:100%; background:var(--panel); color:var(--txt); border:1px solid var(--border);
  border-radius:var(--radius); padding:0 var(--pad); height:var(--touch); box-sizing:border-box; font-size:1em;
}
textarea{min-height: calc(var(--touch)*2.3); padding:14px var(--pad); white-space:pre-wrap; line-height:1.25;}

.row{display:grid; gap:14px;}
.row.two{grid-template-columns:1fr 1fr;}
.row.three{grid-template-columns:1fr 1fr 1fr;}

.tabs{display:flex;gap:10px;margin:14px 0;}
.tabs button{flex:1;height:var(--touch);border-radius:var(--radius);border:1px solid var(--border);background:var(--panel2);color:#0b1d14;background:linear-gradient(0deg,#19D27C,#19D27C);opacity:.85;}
.tabs button.active{opacity:1;}
.btn{height:var(--touch);padding:0 18px;border-radius:var(--radius);border:1px solid var(--border);font-weight:800;font-size:1em;}
.btn.primary{background:var(--accent);color:#0b1d14;}
.btn.ghost{background:var(--panel2);color:#fff;}

.muted{color:var(--sub);font-size:var(--fs-sm);}
#toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:var(--panel2);color:#fff;padding:12px 16px;border-radius:14px;border:1px solid var(--border);opacity:0;pointer-events:none;z-index:10;}
#toast.show{opacity:1;transition:opacity .15s;}
#toast.err{border-color:var(--err);color:#ffdada;}

.lb-row{display:grid; grid-template-columns: 1.6fr 1fr; gap:10px; align-items:center;}
.lb-list{display:flex; flex-direction:column; gap:10px;}

/* ë°°ì¹˜ ë¹Œë” ìµœì í™” */
details > summary {
  list-style: none;
}
details > summary::-webkit-details-marker {
  display: none;
}
details[open] > summary {
  background: var(--panel2) !important;
}

  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Soft Content Sender</h1>
      <div class="muted" style="font-size:0.75em; margin-top:-4px;">v10.1 (2025-10-05)</div>
    </div>
    <div id="status">ë¡œë”©ì¤‘â€¦</div>
  </header>

  <!-- ì‹œíŠ¸ID ì˜¤ë²„ë¼ì´ë“œ -->
  <section class="field">
    <label>Sheet IDs</label>
    <div class="row two">
      <input id="cueId" placeholder="CUE Sheet ID(ì˜µì…˜)" />
      <input id="typeId" placeholder="TYPE Sheet ID(ì˜µì…˜)" />
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px;">
      <button class="btn ghost" id="btnSaveIds">ID ì €ì¥</button>
      <button class="btn ghost" id="btnClearIds">ID ì´ˆê¸°í™”</button>
    </div>
    <div class="muted" id="idsHint" style="margin-top:6px;"></div>
  </section>

  <section class="field">
    <div class="row two">
      <div class="field">
        <label>í–‰ ì„ íƒ(ì‹œê°„)</label>
        <div style="display:flex;gap:12px;align-items:center;">
          <input id="chkAuto" type="checkbox" checked style="width:auto;height:auto;transform:scale(1.4);" />
          <span class="muted">í˜„ì¬ ì‹œê° ìë™ ì„ íƒ</span>
        </div>
      </div>
      <div class="field">
        <label>ì‹œê°„ ë“œë¡­ë‹¤ìš´(Â±20ë¶„)</label>
        <select id="selTime"><option value="">(ë¯¸ì„ íƒ: í˜„ì¬ì‹œê°)</option></select>
      </div>
    </div>
  </section>

  <section class="field">
    <div class="row two">
      <div class="field">
        <label>íŒŒì¼ëª…(ì „ì†¡ ì „ ìˆ˜ì • ê°€ëŠ¥) â€” í˜•ì‹: <b>HHmm_name_mode</b></label>
        <input id="fileName" placeholder="ì˜ˆ: 1742_John_Doe_ELIM / 1742_Table7_LEADERBOARD" />
      </div>
      <div class="field">
        <label>ëª¨ë“œ</label>
        <div class="tabs">
          <button id="tabPU" class="active">ìŠ¤íƒ ì—…ë°ì´íŠ¸(PU)</button>
          <button id="tabELIM">íƒˆë½ ì •ë³´(ELIM)</button>
          <button id="tabL3">í”„ë¡œí•„ ìë§‰(L3)</button>
          <button id="tabLB">ë¦¬ë”ë³´ë“œ(LEADERBOARD)</button>
        </div>
      </div>
    </div>
  </section>

  <section class="field">
    <div class="field">
      <label>í…Œì´ë¸” ì„ íƒ</label>
      <select id="selRoomTable"><option value="">-</option></select>
    </div>

    <div class="field">
      <label>ì¢Œì„ ì„ íƒ</label>
      <select id="selSeat"><option value="">ì¢Œì„ ì„ íƒ</option></select>
    </div>

    <div class="field" id="singleFields">
      <label>êµ­ê°€ ì½”ë“œ (2ìë¦¬)</label>
      <input id="countryCode" placeholder="ì˜ˆ: US, KR" readonly />
    </div>
  </section>

  <!-- PU -->
  <section id="panelPU" class="field">
    <div class="row two">
      <div class="field">
        <label>ì¹©ìŠ¤íƒ(ì‰¼í‘œ í¬í•¨) *</label>
        <input id="stackAmt" placeholder="ì˜ˆ: 1,234,000" inputmode="numeric" />
      </div>
      <div class="field">
        <label>Big Blind(ì •ìˆ˜) *</label>
        <input id="bigBlind" placeholder="ì˜ˆ: 20000" inputmode="numeric" />
      </div>
    </div>
    <div class="row two">
      <div class="field">
        <label>ê³„ì‚°ëœ BB (ìë™, ë°˜ì˜¬ë¦¼)</label>
        <input id="stackBBView" readonly placeholder="ì˜ˆ: 62BB" />
      </div>
      <input id="stackBB" type="hidden" />
    </div>
  </section>

  <!-- ELIM -->
  <section id="panelELIM" class="field" style="display:none;">
    <div class="row two">
      <div class="field">
        <label>ìƒê¸ˆ ì—¬ë¶€</label>
        <select id="selPrize">
          <option value="">ìƒê¸ˆ ì—†ìŒ</option>
          <option value="prize">ìƒê¸ˆ ìˆìŒ</option>
        </select>
      </div>
      <div class="field" id="prizeDetails" style="display:none;">
        <label>ìˆœìœ„ ë° ìƒê¸ˆ</label>
        <div class="row two">
          <input id="prizePlace" placeholder="ì˜ˆ: 5" inputmode="numeric" />
          <input id="prizeAmount" placeholder="ì˜ˆ: 10000" inputmode="numeric" />
        </div>
      </div>
    </div>
  </section>

  <!-- L3 -->
  <section id="panelL3" class="field" style="display:none;">
    <p class="muted">"í”„ë¡œí•„ ìë§‰" + ì´ë¦„ 2ì¤„ì´ Jì…€ì— ì¶”ê°€ë©ë‹ˆë‹¤.</p>
  </section>

  <!-- LEADERBOARD -->
  <section id="panelLB" class="field" style="display:none;">
    <div class="row two">
      <div class="field">
        <label>Level</label>
        <input id="lbLevel" placeholder="ì˜ˆ: 15" inputmode="numeric" />
      </div>
      <div class="field">
        <label>Table Label (íŒŒì¼ëª…ìš©)</label>
        <input id="lbTableLabel" placeholder="ì˜ˆ: Table7" />
      </div>
    </div>
    <div class="row three">
      <div class="field">
        <label>SB</label>
        <input id="lbSB" placeholder="ì˜ˆ: 25000" inputmode="numeric" />
      </div>
      <div class="field">
        <label>BB</label>
        <input id="lbBB" placeholder="ì˜ˆ: 50000" inputmode="numeric" />
      </div>
      <div class="field">
        <label>ANTE</label>
        <input id="lbAnte" placeholder="ì˜ˆ: 50000" inputmode="numeric" />
      </div>
    </div>

    <div class="field">
      <label>í”Œë ˆì´ì–´ ì¹©ìŠ¤íƒ ì…ë ¥(ì´ë¦„ ìë™ ë¡œë“œ, í•„ìš”ì‹œ ìˆ˜ì •)</label>
      <div id="lbList" class="lb-list"></div>
    </div>
  </section>

  <!-- ì•¡ì…˜ ë²„íŠ¼ (ì…ë ¥ ì§í›„ ë°”ë¡œ ì²˜ë¦¬) -->
  <section class="field" style="display:flex;gap:12px;justify-content:flex-end;align-items:center;">
    <button class="btn ghost" id="btnAddToBatch" style="display:none;">
      â• ë°°ì¹˜ì— ì¶”ê°€
    </button>
    <button class="btn primary" id="btnSend" style="min-width:200px;">ì „ì†¡</button>
  </section>

  <!-- ë°°ì¹˜ ë¦¬ìŠ¤íŠ¸ (í•­ëª© ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
  <section id="batchSection" class="field" style="display:none; background:var(--panel2); padding:var(--pad); border-radius:var(--radius); border:2px solid var(--accent);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <label style="margin:0;">ğŸ“¦ ë°°ì¹˜ ëŒ€ê¸° ì¤‘ (<span id="batchCount">0</span>ê±´)</label>
      <button class="btn ghost" id="btnClearBatch" style="height:auto; padding:8px 14px; font-size:0.9em;">
        ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
      </button>
    </div>

    <!-- ë°°ì¹˜ ë¦¬ìŠ¤íŠ¸ -->
    <div id="batchList" style="max-height:250px; overflow-y:auto; -webkit-overflow-scrolling:touch;">
      <!-- ë™ì  ìƒì„± -->
    </div>
  </section>

  <!-- ë¯¸ë¦¬ë³´ê¸° (í†µí•©) -->
  <section class="field">
    <label id="previewLabel">ë¯¸ë¦¬ë³´ê¸°</label>
    <textarea id="preview" readonly></textarea>
  </section>

  <section style="margin-top:12px;">
    <div class="muted" id="footerInfo"></div>
  </section>
</div>

<div id="toast"></div>

<script>
  const LS_KEYS = { CUE:'SCS_CUE_ID', TYPE:'SCS_TYPE_ID' };

  // ìƒìˆ˜ ì •ì˜
const CONSTANTS = {
  TOAST_DURATION: 1800,
  DEFAULT_SEAT_INDEX: 1,
  DEBOUNCE_DELAY: 300,
  MODES: {
    PU: 'PU',
    ELIM: 'ELIM',
    L3: 'L3',
    LEADERBOARD: 'LEADERBOARD'
  },
  DISPLAY: {
    GRID: 'grid',
    BLOCK: 'block',
    NONE: 'none'
  }
};

const state = {
  mode: CONSTANTS.MODES.ELIM,
  tz: 'Asia/Seoul',
  typeRows: [],
  byRoom: {},
  byRoomTable: {},
  tableList: [],     // Room+Table í†µí•© ëª©ë¡
  timeCenter: '',
  cueId: '',
  typeId: '',
  batch: []          // ë°°ì¹˜ ì „ì†¡ìš© ë°°ì—´
};

  function toast(msg, ok=true){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='show'+(ok?'':' err');
  setTimeout(()=>t.className='', CONSTANTS.TOAST_DURATION);
}
function setStatus(s){ document.getElementById('status').textContent=s; }

/* ===== Sheet ID ì €ì¥/ì´ˆê¸°í™” ===== */
function loadIdsFromLocal(){
  const cue = localStorage.getItem(LS_KEYS.CUE) || '';
  const type= localStorage.getItem(LS_KEYS.TYPE) || '';
  if (cue) document.getElementById('cueId').value = cue;
  if (type) document.getElementById('typeId').value = type;
  state.cueId = cue;
  state.typeId= type;
  renderIdsHint();
}
function saveIds(){
  const cue = document.getElementById('cueId').value.trim();
  const type= document.getElementById('typeId').value.trim();
  if (cue) localStorage.setItem(LS_KEYS.CUE, cue); else localStorage.removeItem(LS_KEYS.CUE);
  if (type) localStorage.setItem(LS_KEYS.TYPE, type); else localStorage.removeItem(LS_KEYS.TYPE);
  state.cueId = cue; state.typeId = type;
  renderIdsHint();
  toast('ID ì €ì¥ ì™„ë£Œ');
  reloadSheets();
}
function clearIds(){
  localStorage.removeItem(LS_KEYS.CUE);
  localStorage.removeItem(LS_KEYS.TYPE);
  state.cueId=''; state.typeId='';
  document.getElementById('cueId').value='';
  document.getElementById('typeId').value='';
  renderIdsHint();
  toast('ID ì´ˆê¸°í™” ì™„ë£Œ(ê¸°ë³¸ê°’ ì‚¬ìš©)');
  reloadSheets();
}
function renderIdsHint(){
  const c = state.cueId ? `CUE=${state.cueId}` : 'CUE=ê¸°ë³¸ê°’';
  const t = state.typeId? `TYPE=${state.typeId}`: 'TYPE=ê¸°ë³¸ê°’';
  document.getElementById('idsHint').textContent = `í˜„ì¬ ì‚¬ìš© ì¤‘: ${c} | ${t}`;
}

/* ì¸ë±ì‹± */
function indexTypeRows(rows){
  state.byRoom={}; state.byRoomTable={}; state.tableList=[];
  rows.forEach(r=>{
    (state.byRoom[r.room] ||= []).push(r);
    const key = r.room + '|' + r.tno;
    (state.byRoomTable[key] ||= []).push(r);
  });

  // Room+Table í†µí•© ëª©ë¡ ìƒì„±
  Object.keys(state.byRoomTable).forEach(key => {
    const [room, tno] = key.split('|');
    const tname = state.byRoomTable[key][0]?.tname || '';
    state.tableList.push({
      key,
      label: tname ? `${room} - ${tname} (Table ${tno})` : `${room} - Table ${tno}`,
      room,
      tno
    });
  });

  // ì •ë ¬: Room â†’ Table No.
  state.tableList.sort((a,b) => {
    if (a.room !== b.room) return a.room.localeCompare(b.room);
    return Number(a.tno) - Number(b.tno);
  });
}
function normSeat(s){
  const t = String(s||'').trim();
  if(!t) return '';
  const n = t.replace(/\s/g,'').replace(/^#?/,'');
  return '#'+n;
}

/* í”Œë ˆì´ì–´ ì¡°íšŒ í—¬í¼ í•¨ìˆ˜ */
function findPlayerBySeat(key, seat) {
  if (!key || !seat) return null;
  const arr = state.byRoomTable[key] || [];
  return arr.find(r => normSeat(r.seat) === normSeat(seat));
}

/* ===== UI ì±„ìš°ê¸° ===== */
function fillRoomTables(){
  const sel = document.getElementById('selRoomTable');
  sel.innerHTML = '<option value="">-</option>';

  const fragment = document.createDocumentFragment();
  state.tableList.forEach(t => {
    const o = document.createElement('option');
    o.value = t.key;
    o.textContent = t.label;
    fragment.appendChild(o);
  });
  sel.appendChild(fragment);

  if (sel.options.length > 1) sel.selectedIndex = CONSTANTS.DEFAULT_SEAT_INDEX;
  fillSeats();
}

function fillSeats(){
  const key = document.getElementById('selRoomTable').value;
  const selSeat = document.getElementById('selSeat');
  const prevSeat = selSeat.value;

  selSeat.innerHTML = '<option value="">ì¢Œì„ ì„ íƒ</option>';

  if (!key) return;

  const arr = state.byRoomTable[key] || [];

  // Seat ë“œë¡­ë‹¤ìš´: "#1 - John Doe" í˜•ì‹
  const seats = [...new Set(arr.map(r => normSeat(r.seat)))]
    .sort((a,b) => Number(a.replace('#','')) - Number(b.replace('#','')));

  const fragment = document.createDocumentFragment();
  seats.forEach(s => {
    const player = findPlayerBySeat(key, s);
    const o = document.createElement('option');
    o.value = s;
    o.textContent = `${s} - ${player?.player || ''}`;
    fragment.appendChild(o);
  });
  selSeat.appendChild(fragment);

  const idx = seats.indexOf(prevSeat);
  selSeat.selectedIndex = idx >= 0 ? idx + CONSTANTS.DEFAULT_SEAT_INDEX : (seats.length > 0 ? CONSTANTS.DEFAULT_SEAT_INDEX : 0);

  applyPickFromSeat();
  if(state.mode===CONSTANTS.MODES.LEADERBOARD) buildLeaderboardList();
  rebuildFileName();
}

function applyPickFromSeat(){
  const key = document.getElementById('selRoomTable').value;
  const seat = document.getElementById('selSeat').value;
  const pick = findPlayerBySeat(key, seat);

  if (pick){
    document.getElementById('countryCode').value = pick.nat || '';
  }
  rebuildPreview();
  rebuildFileName();
}

/* ì‹œê°„ ì˜µì…˜ */
function fillTimes(list, center){
  const sel = document.getElementById('selTime');
  sel.innerHTML = '<option value="">(ë¯¸ì„ íƒ: í˜„ì¬ì‹œê°)</option>';

  const fragment = document.createDocumentFragment();
  list.forEach(v=>{
    const o=document.createElement('option');
    o.value=v; o.textContent = (v===center)? `${v}  â† í˜„ì¬` : v;
    fragment.appendChild(o);
  });
  sel.appendChild(fragment);
}

/* íŒŒì¼ëª… */
function hhmmFromTimeStr(t){ return (t||'').replace(':',''); }
function rebuildFileName(){
  const mode   = state.mode;
  const key    = document.getElementById('selRoomTable').value;
  const tno    = key ? key.split('|')[1] : '';
  const picked = document.getElementById('selTime').value;
  const hhmm   = hhmmFromTimeStr( picked || (state.timeCenter||'').slice(0,5) );

  let nameForMode;
  if (mode === CONSTANTS.MODES.LEADERBOARD) {
    nameForMode = document.getElementById('lbTableLabel').value || ('Table'+tno);
  } else {
    const player = getSelectedPlayer();
    nameForMode = player ? player.player : 'Player';
  }

  google.script.run.withSuccessHandler(name=>{
    document.getElementById('fileName').value = name;
  }).buildFileName(mode, hhmm, tno, nameForMode);
}

/* ìˆ«ì ìœ í‹¸ */
function parseIntClean(s){ const n = Number(String(s||'').replace(/[^0-9]/g,'')); return isNaN(n)?0:Math.round(n); }
function comma(n){ return Number(n||0).toLocaleString('en-US'); }

/* ë””ë°”ìš´ì‹± ìœ í‹¸ */
function debounce(func, delay) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => func(...args), delay);
  };
}

/* ì…ë ¥ì°½ ì‹¤ì‹œê°„ ì½¤ë§ˆ í¬ë§· */
function formatInputWithComma(el){
  const v = parseIntClean(el.value);
  el.value = v ? comma(v) : '';
}

/* PU: BB(ë°˜ì˜¬ë¦¼) */
function computeBB(){
  const amt = parseIntClean(document.getElementById('stackAmt').value);
  const bb  = parseIntClean(document.getElementById('bigBlind').value);
  const res = (amt>0 && bb>0) ? Math.round(amt / bb) : '';
  document.getElementById('stackBB').value = res || '';
  document.getElementById('stackBBView').value = res ? `${res}BB` : '';
}

/* LEADERBOARD */
let lbListListenerAttached = false;
let lbTableLabelListenerAttached = false;

function buildLeaderboardList(){
  const key = document.getElementById('selRoomTable').value;
  if (!key) return;

  const arr = (state.byRoomTable[key]||[]).slice()
                .sort((a,b)=>Number(a.seat.replace('#',''))-Number(b.seat.replace('#','')));
  const list = document.getElementById('lbList');
  list.innerHTML = '';

  arr.forEach((r,i)=>{
    const row = document.createElement('div'); row.className='lb-row';
    row.innerHTML = `
      <input class="lbName" value="${(r.player||'')}" />
      <input class="lbAmt"  placeholder="ì¹©ìŠ¤íƒ(ì˜ˆ: 4,190,000)" inputmode="numeric" />
    `;
    list.appendChild(row);
  });

  // ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ í•œ ë²ˆë§Œ ë“±ë¡
  if (!lbListListenerAttached) {
    list.addEventListener('input', (e) => {
      if (e.target.classList.contains('lbAmt')) {
        formatInputWithComma(e.target);
        rebuildPreview();
      } else if (e.target.classList.contains('lbName')) {
        rebuildPreview();
      }
    });
    lbListListenerAttached = true;
  }

  const tno = key.split('|')[1];
  const tlabel = document.getElementById('lbTableLabel');
  if(!tlabel.value) tlabel.value = 'Table'+tno;

  if (!lbTableLabelListenerAttached) {
    tlabel.addEventListener('input', rebuildFileName);
    lbTableLabelListenerAttached = true;
  }

  rebuildPreview();
  rebuildFileName();
}

function nameToInitialLastUpper(full){
  const parts = String(full||'').trim().split(/\s+/);
  if(parts.length===0 || !parts[0]) return '';
  const initial = (parts[0][0]||'').toUpperCase()+'.';
  const last = parts.slice(1).join(' ').toUpperCase();
  return last ? `${initial} ${last}` : initial;
}

// ìˆ«ì â†’ K/M í‘œê¸°(ë¸”ë¼ì¸ë“œ ë¼ë²¨ìš©)
function formatKM(nStr){
  const n = parseIntClean(nStr);
  const [divisor, suffix] = n >= 1_000_000 ? [1_000_000, 'M'] : [1_000, 'K'];

  const formatted = (n / divisor).toFixed(2)
    .replace(/\.0+$/,'')
    .replace(/(\.\d)0$/,'$1');

  return `${formatted}${suffix}`;
}

/* ì„ íƒëœ í”Œë ˆì´ì–´ ì •ë³´ ê°€ì ¸ì˜¤ê¸° */
function getSelectedPlayer(){
  const key = document.getElementById('selRoomTable').value;
  const seat = document.getElementById('selSeat').value;
  return findPlayerBySeat(key, seat);
}

/* ===== ë°ì´í„° ì¬ë¡œë“œ ===== */
function reloadSheets(){
  setStatus('ì‹œíŠ¸ ì •ë³´ ë¡œë”©â€¦');
  google.script.run.withSuccessHandler(res=>{
    if(res?.ok){ state.timeCenter = res.center || ''; fillTimes(res.list||[], res.center||''); rebuildFileName(); }
    else toast('ì‹œê°„ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨: '+(res?.error||'unknown'), false);
    setStatus('ì¤€ë¹„ë¨');
  }).getTimeOptions(state.cueId || null);

  google.script.run.withSuccessHandler(res=>{
    if(res?.ok){ state.typeRows = res.rows||[]; indexTypeRows(state.typeRows); fillRoomTables(); }
    else toast('Type íƒ­ ë¡œë”© ì‹¤íŒ¨: '+(res?.error||'unknown'), false);
  }).getTypeRows(state.typeId || null);
}

  /* ë¯¸ë¦¬ë³´ê¸°(ì „ë¶€ ëŒ€ë¬¸ì ì¶œë ¥) */
function rebuildPreview(){
  const mode = state.mode;

  // DOM ìš”ì†Œ ìºì‹±
  const els = {
    stackAmt: document.getElementById('stackAmt'),
    stackBB: document.getElementById('stackBB'),
    selPrize: document.getElementById('selPrize'),
    lbLevel: document.getElementById('lbLevel'),
    lbSB: document.getElementById('lbSB'),
    lbBB: document.getElementById('lbBB'),
    lbAnte: document.getElementById('lbAnte'),
    preview: document.getElementById('preview')
  };

  let body='';

  if(mode===CONSTANTS.MODES.PU){
    computeBB();
    const player = getSelectedPlayer();
    if (!player) { body = ''; }
    else {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      const amt = (els.stackAmt.value||'').toUpperCase();
      const bb = (els.stackBB.value||'').toUpperCase();
      body = `${name} / ${country}\nCURRENT STACK - ${amt} (${bb}BB)`;
    }
  }else if(mode===CONSTANTS.MODES.ELIM){
    const player = getSelectedPlayer();
    if (!player) { body = ''; }
    else {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();

      if (els.selPrize.value === 'prize') {
        const place = (document.getElementById('prizePlace').value || '').trim();
        const amount = (document.getElementById('prizeAmount').value || '').trim();
        const prizeText = place && amount ? `ELIMINATED IN ${place}TH PLACE (${amount})` : 'ELIMINATED';
        body = `${name} / ${country}\n${prizeText}`;
      } else {
        body = `${name} / ${country}\nELIMINATED`;
      }
    }
  }else if(mode===CONSTANTS.MODES.L3){
    const player = getSelectedPlayer();
    if (!player) { body = ''; }
    else {
      const name = (player.player || '').toUpperCase();
      body = `í”„ë¡œí•„ ìë§‰\n${name}`;
    }
  }else if(mode===CONSTANTS.MODES.LEADERBOARD){
    const level = (els.lbLevel.value||'').trim();
    const sb    = comma(parseIntClean(els.lbSB.value));
    const bb    = comma(parseIntClean(els.lbBB.value));
    const ante  = comma(parseIntClean(els.lbAnte.value));
    const rows = [];
    document.querySelectorAll('#lbList .lb-row').forEach(r=>{
      const name = r.querySelector('.lbName').value;
      const amt  = r.querySelector('.lbAmt').value;
      const chips = parseIntClean(amt);
      if(chips>0) rows.push({name, amt: comma(chips)});
    });
    rows.sort((a,b)=>parseInt(b.amt.replace(/,/g,'')) - parseInt(a.amt.replace(/,/g,'')));
    const lines = rows.map(o => `${nameToInitialLastUpper(o.name)}    ${o.amt}`.toUpperCase());
    const footer = `LV ${String(level||'').toUpperCase()} | BLINDS ${formatKM(sb)} / ${formatKM(bb)} - ${formatKM(ante)}`;
    body = lines.join('\n') + (lines.length?'\n\n':'') + footer;
  }
  els.preview.value = body;
}

// í˜„ì¬ ì…ë ¥ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
function generateCurrentPreview() {
  const mode = state.mode;
  const els = {
    stackAmt: document.getElementById('stackAmt'),
    stackBB: document.getElementById('stackBB'),
    selPrize: document.getElementById('selPrize'),
    lbLevel: document.getElementById('lbLevel'),
    lbSB: document.getElementById('lbSB'),
    lbBB: document.getElementById('lbBB'),
    lbAnte: document.getElementById('lbAnte')
  };

  let body = '';

  if (mode === CONSTANTS.MODES.PU) {
    computeBB();
    const player = getSelectedPlayer();
    if (player) {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      const amt = (els.stackAmt.value || '').toUpperCase();
      const bb = (els.stackBB.value || '').toUpperCase();
      body = `${name} / ${country}\nCURRENT STACK - ${amt} (${bb}BB)`;
    }
  } else if (mode === CONSTANTS.MODES.ELIM) {
    const player = getSelectedPlayer();
    if (player) {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      if (els.selPrize.value === 'prize') {
        const place = (document.getElementById('prizePlace').value || '').trim();
        const amount = (document.getElementById('prizeAmount').value || '').trim();
        const prizeText = place && amount ? `ELIMINATED IN ${place}TH PLACE (${amount})` : 'ELIMINATED';
        body = `${name} / ${country}\n${prizeText}`;
      } else {
        body = `${name} / ${country}\nELIMINATED`;
      }
    }
  } else if (mode === CONSTANTS.MODES.L3) {
    const player = getSelectedPlayer();
    if (player) {
      const name = (player.player || '').toUpperCase();
      body = `í”„ë¡œí•„ ìë§‰\n${name}`;
    }
  } else if (mode === CONSTANTS.MODES.LEADERBOARD) {
    const level = (els.lbLevel.value || '').trim();
    const sb = comma(parseIntClean(els.lbSB.value));
    const bb = comma(parseIntClean(els.lbBB.value));
    const ante = comma(parseIntClean(els.lbAnte.value));
    const rows = [];
    document.querySelectorAll('#lbList .lb-row').forEach(r => {
      const name = r.querySelector('.lbName').value;
      const amt = r.querySelector('.lbAmt').value;
      const chips = parseIntClean(amt);
      if (chips > 0) rows.push({ name, amt: comma(chips) });
    });
    rows.sort((a, b) => parseInt(b.amt.replace(/,/g, '')) - parseInt(a.amt.replace(/,/g, '')));
    const lines = rows.map(o => `${nameToInitialLastUpper(o.name)}    ${o.amt}`.toUpperCase());
    const footer = `LV ${String(level || '').toUpperCase()} | BLINDS ${formatKM(sb)} / ${formatKM(bb)} - ${formatKM(ante)}`;
    body = lines.join('\n') + (lines.length ? '\n\n' : '') + footer;
  }

  return body;
}

// ë¯¸ë¦¬ë³´ê¸° í†µí•© ì—…ë°ì´íŠ¸
function updateBatchPreview() {
  const previewEl = document.getElementById('preview');
  const previewLabel = document.getElementById('previewLabel');

  if (state.batch.length > 0) {
    // ë°°ì¹˜ ëª¨ë“œ: ë°°ì¹˜ ì „ì²´ ë‚´ìš© + í˜„ì¬ ì…ë ¥ í‘œì‹œ
    const batchContent = state.batch.map(item => item.content).join('\n\n');
    const currentPreview = generateCurrentPreview();

    previewLabel.textContent = `ë¯¸ë¦¬ë³´ê¸° (ë°°ì¹˜ ${state.batch.length}ê±´ + í˜„ì¬ ì…ë ¥)`;
    previewEl.value = `=== ë°°ì¹˜ ì „ì†¡ë  ë‚´ìš© (${state.batch.length}ê±´) ===\n\n${batchContent}\n\n=== í˜„ì¬ ì…ë ¥ (ë°°ì¹˜ì— ì¶”ê°€í•˜ë ¤ë©´ [â• ë°°ì¹˜ì— ì¶”ê°€] í´ë¦­) ===\n\n${currentPreview}`;
  } else {
    // ë‹¨ì¼ ëª¨ë“œ
    previewLabel.textContent = 'ë¯¸ë¦¬ë³´ê¸°';
    rebuildPreview();
  }
}

  /* ===== ë°°ì¹˜ ë¹Œë” (ìŠ¤ë§ˆíŠ¸ í†µí•©) ===== */

// ìŠ¤ë§ˆíŠ¸ ì „ì†¡ ë²„íŠ¼ ì—…ë°ì´íŠ¸
function updateSendButton() {
  const btnSend = document.getElementById('btnSend');
  const btnAddToBatch = document.getElementById('btnAddToBatch');
  const batchSection = document.getElementById('batchSection');

  if (state.batch.length > 0) {
    // ë°°ì¹˜ ëª¨ë“œ
    btnSend.innerHTML = `ğŸ“¤ ë°°ì¹˜ ì „ì†¡ (${state.batch.length}ê±´)`;
    batchSection.style.display = 'block';
  } else {
    // ë‹¨ì¼ ëª¨ë“œ
    btnSend.innerHTML = 'ì „ì†¡';
    batchSection.style.display = 'none';
  }

  // ë°°ì¹˜ ì¶”ê°€ ë²„íŠ¼ì€ LEADERBOARD ëª¨ë“œê°€ ì•„ë‹ ë•Œ í•­ìƒ í‘œì‹œ
  btnAddToBatch.style.display = (state.mode === CONSTANTS.MODES.LEADERBOARD) ? 'none' : 'block';
}

// ë°°ì¹˜ì— ì¶”ê°€
function addToBatch() {
  const preview = document.getElementById('preview').value.trim();

  if (!preview) {
    toast('ë¯¸ë¦¬ë³´ê¸°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë¨¼ì € í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ê³  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', false);
    return;
  }

  const player = getSelectedPlayer();
  const mode = state.mode;

  state.batch.push({
    mode,
    player: player?.player || 'Unknown',
    seat: player?.seat || '',
    nat: player?.nat || '',
    content: preview
  });

  renderBatchList();
  updateBatchPreview();
  updateSendButton();
  toast(`âœ… ë°°ì¹˜ì— ì¶”ê°€ë¨ (${state.batch.length}ê±´)`, true);

  moveToNextSeat();
}

// ë°°ì¹˜ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function renderBatchList() {
  const list = document.getElementById('batchList');

  if (state.batch.length === 0) {
    list.innerHTML = '';
    document.getElementById('batchCount').textContent = '0';
    return;
  }

  list.innerHTML = '';

  state.batch.forEach((item, idx) => {
    const div = document.createElement('div');
    div.style.cssText = 'background:var(--panel); padding:14px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; min-height:44px;';

    div.innerHTML = `
      <div style="flex:1; min-width:0;">
        <div style="font-weight:600; font-size:0.95em;">
          ${idx + 1}. ${item.seat} ${item.player}
          <span style="color:var(--accent); margin-left:8px; font-size:0.85em;">[${item.mode}]</span>
        </div>
        <div class="muted" style="font-size:0.8em; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          ${item.content.replace(/\n/g, ' Â· ').substring(0, 60)}...
        </div>
      </div>
      <button class="btn ghost" data-idx="${idx}" style="padding:10px 16px; height:auto; font-size:0.85em; margin-left:10px; flex-shrink:0;">
        ì‚­ì œ
      </button>
    `;

    div.querySelector('button').addEventListener('click', (e) => {
      const idx = parseInt(e.target.dataset.idx);
      state.batch.splice(idx, 1);
      renderBatchList();
      updateBatchPreview();
      updateSendButton();
      toast('í•­ëª© ì‚­ì œë¨', true);
    });

    list.appendChild(div);
  });

  document.getElementById('batchCount').textContent = state.batch.length;
}

// ë‹¤ìŒ ì¢Œì„ìœ¼ë¡œ ìë™ ì´ë™
function moveToNextSeat() {
  const key = document.getElementById('selRoomTable').value;
  const seat = document.getElementById('selSeat').value;
  const arr = state.byRoomTable[key] || [];

  const seats = [...new Set(arr.map(r => normSeat(r.seat)))]
    .sort((a,b) => Number(a.replace('#','')) - Number(b.replace('#','')));

  const currentIndex = seats.indexOf(seat);

  if (currentIndex >= 0 && currentIndex < seats.length - 1) {
    const nextSeat = seats[currentIndex + 1];
    document.getElementById('selSeat').value = nextSeat;
    applyPickFromSeat();
    rebuildPreview();
    rebuildFileName();
  } else {
    if (seats.length > 0) {
      document.getElementById('selSeat').value = seats[0];
      applyPickFromSeat();
      rebuildPreview();
      rebuildFileName();
    }
  }
}

// ë°°ì¹˜ ì „ì†¡
function sendBatch() {
  if (state.batch.length === 0) {
    toast('ë°°ì¹˜ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.', false);
    return;
  }

  const jBlock = state.batch.map(item => item.content).join('\n\n');

  const autoNow = document.getElementById('chkAuto').checked;
  const picked = document.getElementById('selTime').value;
  const timeStr = autoNow ? state.timeCenter.slice(0,5) : picked;
  const hhmm = hhmmFromTimeStr(timeStr);
  const filename = `${hhmm}_Batch_${state.batch.length}items`;

  const payload = {
    autoNow,
    pickedTime: picked,
    tz: state.tz,
    kind: 'BATCH',
    eFix: 'ë¯¸ì™„ë£Œ',
    gFix: 'SOFT',
    filename,
    jBlock,
    cueId: state.cueId || undefined
  };

  setStatus('ì „ì†¡ ì¤‘â€¦');

  google.script.run
    .withSuccessHandler(res => {
      if (!res?.ok) {
        toast('âŒ ì „ì†¡ ì‹¤íŒ¨: ' + (res?.error || 'unknown'), false);
        setStatus('ì—ëŸ¬');
        return;
      }

      toast(`âœ… ë°°ì¹˜ ì „ì†¡ ì™„ë£Œ! ${state.batch.length}ê±´ì´ í–‰ ${res.row}(${res.time})ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, true);
      setStatus('ì¤€ë¹„ë¨');

      state.batch = [];
      renderBatchList();
      updateBatchPreview();
      updateSendButton();
    })
    .withFailureHandler(err => {
      toast('âŒ ì„œë²„ ì˜¤ë¥˜: ' + (err?.message || err), false);
      setStatus('ì—ëŸ¬');
    })
    .updateVirtual(payload);
}

/* ìŠ¤ë§ˆíŠ¸ ì „ì†¡ (ë‹¨ì¼/ë°°ì¹˜ ìë™ ê°ì§€) */
function send(){
  // ë°°ì¹˜ ëª¨ë“œì¸ì§€ í™•ì¸
  if (state.batch.length > 0) {
    sendBatch();
    return;
  }

  // ë‹¨ì¼ ì „ì†¡
  sendSingle();
}

// ë‹¨ì¼ ì „ì†¡
function sendSingle() {
  const autoNow = document.getElementById('chkAuto').checked;
  const picked  = document.getElementById('selTime').value;
  const filename= document.getElementById('fileName').value.trim();
  const jBlock  = generateCurrentPreview(); // ë°°ì¹˜ ë¯¸ë¦¬ë³´ê¸° ì œì™¸

  if(!jBlock){ toast('ë¯¸ë¦¬ë³´ê¸° ë‚´ìš©ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.', false); return; }
  if(!filename){ toast('íŒŒì¼ëª… ë¹„ì–´ìˆìŒ.', false); return; }
  if(state.mode===CONSTANTS.MODES.PU){
    if(!parseIntClean(document.getElementById('stackAmt').value) || !parseIntClean(document.getElementById('bigBlind').value)){
      toast('ì¹©ìŠ¤íƒ/ë¹…ë¸”ì„ ì…ë ¥í•˜ì„¸ìš”.', false); return;
    }
  }
  if(state.mode===CONSTANTS.MODES.LEADERBOARD){
    const ok = !!document.getElementById('lbLevel').value.trim()
      && parseIntClean(document.getElementById('lbSB').value)>0
      && parseIntClean(document.getElementById('lbBB').value)>0
      && parseIntClean(document.getElementById('lbAnte').value)>0
      && Array.from(document.querySelectorAll('#lbList .lbAmt')).some(i=>parseIntClean(i.value)>0);
    if(!ok){ toast('ë ˆë²¨/SB/BB/ANTE ë° ì¹©ìŠ¤íƒì„ ì…ë ¥í•˜ì„¸ìš”.', false); return; }
  }
  if(state.mode===CONSTANTS.MODES.ELIM){
    const prizeValue = document.getElementById('selPrize').value;
    if(prizeValue === 'prize'){
      const place = document.getElementById('prizePlace').value.trim();
      const amount = document.getElementById('prizeAmount').value.trim();
      if(!place || !amount){
        toast('ìˆœìœ„ì™€ ìƒê¸ˆì„ ì…ë ¥í•˜ì„¸ìš”.', false); return;
      }
    }
  }

  setStatus('ì „ì†¡ ì¤‘â€¦');
  google.script.run.withSuccessHandler(res=>{
    if(!res?.ok){ toast('ì‹¤íŒ¨: '+(res?.error||'unknown'), false); setStatus('ì—ëŸ¬'); return; }
    toast(`í–‰ ${res.row}(${res.time}) ê°±ì‹  ì™„ë£Œ`);
    setStatus('ì¤€ë¹„ë¨');
  }).withFailureHandler(err=>{
    toast('ì„œë²„ ì˜¤ë¥˜: '+(err?.message||err), false);
    setStatus('ì—ëŸ¬');
  }).updateVirtual({
    autoNow,
    pickedTime: picked,
    tz: state.tz,
    kind: state.mode,
    eFix: 'ë¯¸ì™„ë£Œ',
    gFix: 'SOFT',
    filename,
    jBlock,
    cueId: state.cueId || undefined
  });
}

  // ëª¨ë“œ ë³€ê²½
function setMode(m){
  state.mode = m;
  document.getElementById('tabPU').classList.toggle('active', m===CONSTANTS.MODES.PU);
  document.getElementById('tabELIM').classList.toggle('active', m===CONSTANTS.MODES.ELIM);
  document.getElementById('tabL3').classList.toggle('active', m===CONSTANTS.MODES.L3);
  document.getElementById('tabLB').classList.toggle('active', m===CONSTANTS.MODES.LEADERBOARD);

  document.getElementById('panelPU').style.display   = (m===CONSTANTS.MODES.PU)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;
  document.getElementById('panelELIM').style.display = (m===CONSTANTS.MODES.ELIM)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;
  document.getElementById('panelL3').style.display   = (m===CONSTANTS.MODES.L3)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;
  document.getElementById('panelLB').style.display   = (m===CONSTANTS.MODES.LEADERBOARD)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;

  const showSingle = (m!==CONSTANTS.MODES.LEADERBOARD);
  document.getElementById('singleFields').style.display= showSingle ? CONSTANTS.DISPLAY.GRID : CONSTANTS.DISPLAY.NONE;

  // ë°°ì¹˜ ì‘ì—… ì¤‘ ëª¨ë“œ ë³€ê²½ ì‹œ í”¼ë“œë°±
  if (state.batch.length > 0) {
    const modeNames = {
      PU: 'ìŠ¤íƒ ì—…ë°ì´íŠ¸',
      ELIM: 'íƒˆë½ ì •ë³´',
      L3: 'í”„ë¡œí•„ ìë§‰',
      LEADERBOARD: 'ë¦¬ë”ë³´ë“œ'
    };
    toast(`âš ï¸ ëª¨ë“œ ë³€ê²½: ${modeNames[m]}`, true);
  }

  if(m===CONSTANTS.MODES.LEADERBOARD) buildLeaderboardList();
  rebuildPreview();
  rebuildFileName();
  updateSendButton();  // ëª¨ë“œ ë³€ê²½ ì‹œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
}

  function init(){
  google.script.run.withSuccessHandler(info=>{
    state.tz = info?.tz || 'Asia/Seoul';
    document.getElementById('footerInfo').textContent =
      `ê¸°ë³¸ CUE: ${info?.cueId}  |  ê¸°ë³¸ TYPE: ${info?.typeId}  |  TZ=${state.tz}`;
    setStatus('ì¤€ë¹„ë¨');
  }).getBootstrap();

  loadIdsFromLocal();
  reloadSheets();

  document.getElementById('btnSaveIds').onclick = saveIds;
  document.getElementById('btnClearIds').onclick = clearIds;

  document.getElementById('tabPU').onclick   = ()=>setMode(CONSTANTS.MODES.PU);
  document.getElementById('tabELIM').onclick = ()=>setMode(CONSTANTS.MODES.ELIM);
  document.getElementById('tabL3').onclick   = ()=>setMode(CONSTANTS.MODES.L3);
  document.getElementById('tabLB').onclick   = ()=>setMode(CONSTANTS.MODES.LEADERBOARD);
  document.getElementById('btnSend').onclick = send;

  // ë°°ì¹˜ ì¶”ê°€ ë²„íŠ¼
  document.getElementById('btnAddToBatch').addEventListener('click', addToBatch);

  // ë°°ì¹˜ ì „ì²´ ì‚­ì œ
  document.getElementById('btnClearBatch').addEventListener('click', () => {
    if (state.batch.length === 0) return;

    if (confirm(`${state.batch.length}ê°œ í•­ëª©ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      state.batch = [];
      renderBatchList();
      updateBatchPreview();
      updateSendButton();
      toast('ë°°ì¹˜ ì´ˆê¸°í™”ë¨', true);
    }
  });

  // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤: Ctrl+B
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
      e.preventDefault();
      if (state.batch.length > 0 || document.getElementById('btnAddToBatch').style.display !== 'none') {
        addToBatch();
      }
    }
  });

  document.getElementById('selRoomTable').addEventListener('change', fillSeats);
  document.getElementById('selSeat').addEventListener('change', applyPickFromSeat);

  // ë””ë°”ìš´ì‹±ëœ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
  const debouncedRebuild = debounce(() => {
    rebuildPreview();
    rebuildFileName();
  }, CONSTANTS.DEBOUNCE_DELAY);

  const stackAmt = document.getElementById('stackAmt');
  stackAmt.addEventListener('input', ()=>{ formatInputWithComma(stackAmt); computeBB(); debouncedRebuild(); });
  const bigBlind = document.getElementById('bigBlind');
  bigBlind.addEventListener('input', ()=>{ formatInputWithComma(bigBlind); computeBB(); debouncedRebuild(); });

  // ELIM ëª¨ë“œ: ìƒê¸ˆ ì—¬ë¶€ì— ë”°ë¼ ì…ë ¥ë€ í‘œì‹œ/ìˆ¨ê¹€
  document.getElementById('selPrize').addEventListener('change', (e) => {
    const prizeDetails = document.getElementById('prizeDetails');
    prizeDetails.style.display = e.target.value === 'prize' ? CONSTANTS.DISPLAY.BLOCK : CONSTANTS.DISPLAY.NONE;
    rebuildPreview();
  });

  // ELIM ëª¨ë“œ: ìˆœìœ„/ìƒê¸ˆ ì…ë ¥ ì‹œ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
  document.getElementById('prizePlace').addEventListener('input', debouncedRebuild);
  document.getElementById('prizeAmount').addEventListener('input', debouncedRebuild);

  setMode(CONSTANTS.MODES.ELIM);
}

window.addEventListener('load', init);

</script>
</body>
</html>
