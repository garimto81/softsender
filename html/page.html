<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Soft Content Sender v13.0</title>

  <style>
    /* ============================================
       Modern CSS Design System (v12.0)
       ============================================ */

    :root {
      /* Colors */
      --bg: #0E0F10;
      --panel: #141516;
      --panel2: #1B1C1D;
      --border: #2A2B2C;
      --txt: #F2F3F5;
      --sub: #B9C0CC;
      --accent-pu: #19D27C;
      --accent-elim: #FF6464;
      --accent-l3: #4A9EFF;
      --radius: 8px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100vh;
      height: 100dvh;
      background: var(--bg);
      color: var(--txt);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
      touch-action: manipulation;
      overscroll-behavior: none;
    }

    body {
      padding-top: env(safe-area-inset-top);
      padding-bottom: 0;
    }

    /* Container - 1x12 Grid Layout for Mobile */
    .main-container {
      display: grid;
      grid-template-rows: auto auto auto 1fr auto; /* header, mode-bar, player-grid, selected-list, send-bar */
      height: 100vh;
      height: 100dvh;
      width: 100%;
      max-width: 768px;
      margin: 0 auto;
      background: var(--bg);
      gap: 0;
    }

    /* ============================================
       1. Header (Row 1)
       ============================================ */
    .header {
      min-height: clamp(44px, 7vh, 52px);
      display: grid;
      grid-template-columns: 1fr 1fr auto auto auto;
      align-items: center;
      gap: clamp(4px, 1vw, 8px);
      padding: clamp(6px, 1vh, 8px) clamp(8px, 2vw, 12px);
      border-bottom: 1px solid var(--border);
    }

    .header select {
      background: var(--panel2);
      color: var(--txt);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0 8px;
      min-height: clamp(36px, 5.5vh, 44px);
      font-size: clamp(12px, 2vw, 14px);
      min-width: 0;
      cursor: pointer;
    }

    .header-bb {
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .header-bb label {
      font-size: clamp(11px, 1.8vw, 13px);
      color: var(--accent-pu);
      font-weight: 700;
    }

    #commonBB {
      background: var(--panel2);
      color: var(--txt);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0 8px;
      min-height: clamp(36px, 5.5vh, 44px);
      width: clamp(4rem, 12vw, 6rem);
      font-size: clamp(12px, 2vw, 14px);
      font-weight: 600;
    }

    .header-badge {
      background: var(--accent-pu);
      color: #0b1d14;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 700;
      font-size: clamp(11px, 1.8vw, 13px);
      white-space: nowrap;
      min-height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-settings {
      width: clamp(36px, 5.5vh, 44px);
      height: clamp(36px, 5.5vh, 44px);
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      font-size: clamp(16px, 3vw, 20px);
      transition: background 0.2s;
    }

    .header-settings:hover {
      background: var(--panel);
    }

    /* 2. 모드 바 (Row 2) */
    .mode-bar{
      height:clamp(40px, 6vh, 52px);
      min-height:40px;
      display:flex;
      gap:clamp(6px, 1.5vw, 10px);
      padding:clamp(6px, 1vh, 8px) clamp(8px, 2vw, 12px);
    }

    .mode-btn{
      flex:1;
      height:100%;
      border:2px solid var(--border);
      border-radius:var(--radius);
      background:var(--panel2);
      color:var(--sub);
      font-weight:700;
      font-size:clamp(12px, 2.2vw, 15px);
      cursor:pointer;
      transition:all 0.15s;
    }

    .mode-btn.active-pu{
      background:var(--accent-pu);
      color:#0b1d14;
      border-color:var(--accent-pu);
    }

    .mode-btn.active-elim{
      background:var(--accent-elim);
      color:#fff;
      border-color:var(--accent-elim);
    }

    .mode-btn.active-l3{
      background:var(--accent-l3);
      color:#fff;
      border-color:var(--accent-l3);
    }

    .mode-btn:active{transform:scale(0.96);}

    /* 3. 플레이어 그리드 (Row 3) - 9개 고정 슬롯 */
    .player-grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      grid-template-rows:repeat(3, 1fr);
      gap:clamp(4px, 1vw, 6px);
      padding:clamp(6px, 1vh, 8px) clamp(8px, 2vw, 12px);
      min-height: clamp(120px, 18vh, 160px);
      max-height: clamp(120px, 18vh, 160px);
      overflow: hidden;
    }

    .player-pill{
      border:1.5px solid var(--border);
      border-radius:clamp(16px, 3vh, 20px);
      background:var(--panel2);
      color:var(--sub);
      font-size:clamp(10px, 1.8vw, 12px);
      font-weight:600;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:all 0.15s;
      padding:0 clamp(4px, 1vw, 6px);
    }

    .player-pill::before{
      content:'○';
      margin-right:3px;
      font-size:clamp(11px, 2vw, 14px);
    }

    .player-pill.selected-pu{
      background:rgba(25,210,124,0.15);
      border-color:var(--accent-pu);
      color:var(--accent-pu);
    }
    .player-pill.selected-pu::before{content:'●';}

    .player-pill.selected-elim{
      background:rgba(255,100,100,0.15);
      border-color:var(--accent-elim);
      color:var(--accent-elim);
    }
    .player-pill.selected-elim::before{content:'◐';}

    .player-pill.selected-l3{
      background:rgba(74,158,255,0.15);
      border-color:var(--accent-l3);
      color:var(--accent-l3);
    }
    .player-pill.selected-l3::before{content:'◑';}

    .player-pill:active{transform:scale(0.94);}

    /* 4. 선택 리스트 (Row 4) - 남은 공간 모두 사용 */
    .selected-list{
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling:touch;
      scroll-snap-type:y proximity;
      padding:0 clamp(8px, 2vw, 12px) clamp(8px, 1vh, 10px);
    }

    .selected-list::-webkit-scrollbar{
      width:4px;
    }

    .selected-list::-webkit-scrollbar-track{
      background:transparent;
    }

    .selected-list::-webkit-scrollbar-thumb{
      background:var(--border);
      border-radius:2px;
    }

    .empty-state{
      text-align:center;
      padding:clamp(40px, 8vh, 80px) 20px;
      color:var(--sub);
      font-size:clamp(12px, 2vw, 14px);
    }

    .selected-card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:clamp(6px, 1.5vh, 10px) clamp(8px, 2vw, 12px);
      margin-bottom:clamp(6px, 1vh, 10px);
      min-height:clamp(60px, 9vh, 80px);
      scroll-snap-align:start;
    }

    .selected-card.mode-pu{border-left:3px solid var(--accent-pu);}
    .selected-card.mode-elim{border-left:3px solid var(--accent-elim);}
    .selected-card.mode-l3{border-left:3px solid var(--accent-l3); min-height:clamp(48px, 7vh, 60px);}

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:clamp(4px, 1vh, 8px);
    }

    .card-name{
      font-weight:700;
      font-size:clamp(12px, 2.2vw, 14px);
      flex:1;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .card-remove{
      width:clamp(20px, 3.5vh, 28px);
      height:clamp(20px, 3.5vh, 28px);
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:4px;
      cursor:pointer;
      color:var(--sub);
      font-size:clamp(14px, 2.5vw, 18px);
      flex-shrink:0;
      margin-left:8px;
    }

    .card-remove:active{
      background:var(--accent-elim);
      color:#fff;
    }

    .card-input{
      display:flex;
      align-items:center;
      gap:clamp(4px, 1vw, 8px);
      margin-top:clamp(4px, 1vh, 8px);
    }

    .card-input input,
    .card-input select{
      flex:1;
      background:var(--panel2);
      color:var(--txt);
      border:1px solid var(--border);
      border-radius:6px;
      padding:0 8px;
      height:clamp(28px, 4.5vh, 36px);
      font-size:clamp(12px, 2vw, 14px);
    }

    .card-input input:focus,
    .card-input select:focus{
      outline:none;
      border-color:var(--accent-pu);
    }

    .card-bb{
      font-size:clamp(10px, 1.8vw, 12px);
      color:var(--accent-pu);
      font-weight:700;
      min-width:clamp(35px, 7vw, 50px);
      text-align:right;
      flex-shrink:0;
    }

    .card-hint{
      font-size:clamp(10px, 1.8vw, 12px);
      color:var(--sub);
      margin-top:4px;
      font-style:italic;
    }

    /* 5. 전송 버튼 (Row 5) */
    .send-bar{
      height:calc(clamp(52px, 8vh, 64px) + env(safe-area-inset-bottom));
      min-height:calc(52px + env(safe-area-inset-bottom));
      background:var(--bg);
      border-top:1px solid var(--border);
      padding:clamp(6px, 1vh, 8px) clamp(8px, 2vw, 12px);
      padding-bottom:calc(clamp(6px, 1vh, 8px) + env(safe-area-inset-bottom));
      display:flex;
      align-items:center;
    }

    .btn-send{
      width:100%;
      height:clamp(48px, 7vh, 56px);
      background:var(--accent-pu);
      color:#0b1d14;
      border:none;
      border-radius:var(--radius);
      font-weight:700;
      font-size:clamp(15px, 2.5vw, 17px);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:all 0.2s;
    }

    .btn-send:active{transform:scale(0.97);}
    .btn-send:disabled{opacity:0.4; cursor:not-allowed;}

    /* 모달 */
    .modal{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.9);
      backdrop-filter:blur(8px);
      z-index:1000;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .modal.show{display:flex;}

    .modal-content{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:clamp(16px, 3vh, 24px);
      width:100%;
      max-width:min(400px, 90vw);
      max-height:80vh;
      overflow-y:auto;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:1px solid var(--border);
    }

    .modal-title{font-size:clamp(16px, 3vw, 20px); font-weight:700;}

    .modal-close{
      width:clamp(28px, 5vh, 36px);
      height:clamp(28px, 5vh, 36px);
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:6px;
      cursor:pointer;
      font-size:clamp(18px, 3vw, 24px);
    }

    .modal-section{margin:16px 0;}

    .modal-label{
      display:block;
      margin-bottom:6px;
      color:var(--sub);
      font-size:clamp(12px, 2vw, 14px);
      font-weight:600;
    }

    .modal-input{
      width:100%;
      background:var(--panel2);
      color:var(--txt);
      border:1px solid var(--border);
      border-radius:6px;
      padding:0 12px;
      height:clamp(40px, 6vh, 48px);
      font-size:clamp(13px, 2.2vw, 15px);
    }

    .modal-input:focus{outline:none; border-color:var(--accent-pu);}

    .modal-hint{
      font-size:clamp(10px, 1.8vw, 12px);
      color:var(--sub);
      margin-top:4px;
    }

    .modal-buttons{display:flex; gap:8px; margin-top:16px;}

    .modal-btn{
      flex:1;
      height:clamp(40px, 6vh, 48px);
      border-radius:6px;
      border:1px solid var(--border);
      font-weight:700;
      cursor:pointer;
      background:var(--panel2);
      color:var(--txt);
      font-size:clamp(13px, 2.2vw, 15px);
    }

    .modal-btn.primary{
      background:var(--accent-pu);
      color:#0b1d14;
      border-color:var(--accent-pu);
    }

    /* 로딩 */
    .loading{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.95);
      z-index:2000;
      display:none;
      align-items:center;
      justify-content:center;
      backdrop-filter:blur(6px);
    }

    .loading.show{display:flex;}

    .loading-content{text-align:center; color:#fff;}

    .spinner{
      width:clamp(40px, 8vw, 56px);
      height:clamp(40px, 8vw, 56px);
      border:4px solid rgba(255,255,255,0.1);
      border-top-color:var(--accent-pu);
      border-radius:50%;
      animation:spin 0.6s linear infinite;
      margin:0 auto 16px;
    }

    @keyframes spin{to{transform:rotate(360deg);}}

    .loading-msg{font-size:clamp(16px, 3vw, 20px); font-weight:600; margin-bottom:8px;}
    .loading-detail{font-size:clamp(12px, 2vw, 14px); color:var(--sub);}

    /* 토스트 */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(clamp(48px, 7vh, 60px) + env(safe-area-inset-bottom) + 12px);
      background:var(--panel2);
      color:#fff;
      padding:12px 20px;
      border-radius:8px;
      border:1px solid var(--border);
      opacity:0;
      pointer-events:none;
      z-index:3000;
      max-width:90%;
      box-shadow:0 4px 12px rgba(0,0,0,0.5);
      transition:opacity 0.2s;
      font-size:clamp(12px, 2vw, 14px);
    }

    .toast.show{opacity:1;}
    .toast.error{border-color:var(--accent-elim); background:#2a1414; color:#ffdada;}
    .toast.success{border-color:var(--accent-pu); background:#0f2a1d; color:#9fe7cc;}

  </style>
</head>
<body>
<div class="main-container">
  <!-- 1. 헤더 -->
  <div class="header">
    <select id="selRoom"><option value="">Room</option></select>
    <select id="selTableNo"><option value="">Table</option></select>
    <div class="header-bb">
      <label>BB</label>
      <input id="commonBB" placeholder="50K" inputmode="numeric" />
    </div>
    <span class="header-badge" id="headerBadge">0</span>
    <div class="header-settings" onclick="openSettings()">⚙️</div>
  </div>

  <!-- 2. 모드 바 -->
  <div class="mode-bar">
    <button class="mode-btn active-pu" id="modeBtn_PU" onclick="setActiveMode('PU')">칩업</button>
    <button class="mode-btn" id="modeBtn_ELIM" onclick="setActiveMode('ELIM')">탈락</button>
    <button class="mode-btn" id="modeBtn_L3" onclick="setActiveMode('L3')">프로필</button>
  </div>

  <!-- 3. 플레이어 그리드 -->
  <div class="player-grid" id="playerGrid"></div>

  <!-- 4. 선택 리스트 (동적 높이) -->
  <div class="selected-list" id="selectedList">
    <div class="empty-state">플레이어를 선택하세요</div>
  </div>

  <!-- 5. 전송 버튼 -->
  <div class="send-bar">
    <button class="btn-send" id="btnSend" onclick="send()">
      <span>📤</span>
      <span id="sendBtnText">전송</span>
    </button>
  </div>
</div>

<!-- 설정 모달 -->
<div class="modal" id="settingsModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">⚙️ 설정</div>
      <div class="modal-close" onclick="closeSettings()">×</div>
    </div>
    <div class="modal-section">
      <label class="modal-label">CUE Sheet ID / Link</label>
      <input class="modal-input" id="cueId" placeholder="ID 또는 링크" />
      <div class="modal-hint">링크를 붙여넣으면 ID 자동 추출</div>
    </div>
    <div class="modal-section">
      <label class="modal-label">TYPE Sheet ID / Link</label>
      <input class="modal-input" id="typeId" placeholder="ID 또는 링크" />
    </div>
    <div class="modal-section">
      <label class="modal-label">시간 선택</label>
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <input type="checkbox" id="chkAuto" checked style="width:auto; height:auto; transform:scale(1.3);" />
        <span style="color:var(--sub); font-size:clamp(11px, 2vw, 13px);">현재 시각 자동</span>
      </div>
      <select class="modal-input" id="selTime"><option value="">자동</option></select>
    </div>
    <div class="modal-buttons">
      <button class="modal-btn" onclick="clearIds()">초기화</button>
      <button class="modal-btn primary" onclick="saveIds()">저장</button>
    </div>
    <div class="modal-hint" style="margin-top:8px;" id="idsHint"></div>
  </div>
</div>

<!-- 로딩 -->
<div class="loading" id="loadingOverlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <div class="loading-msg" id="loadingMsg">전송 중...</div>
    <div class="loading-detail" id="loadingDetail"></div>
  </div>
</div>

<!-- 토스트 -->
<div class="toast" id="toast"></div>



<script>
  const LS_KEYS = { CUE:'SCS_CUE_ID', TYPE:'SCS_TYPE_ID', BB:'SCS_LAST_BB', MODE:'SCS_LAST_MODE' };
  const state = {
    tz: 'Asia/Seoul',
    typeRows: [],
    byRoom: {},
    byRoomTable: {},
    timeCenter: '',
    cueId: '',
    typeId: '',
    countryMap: {},
    activeMode: 'PU',
    selectedPlayers: new Map(),
    isProcessing: false,
    scCounter: 0 // 파일명 시퀀스
  };

  /* 유틸리티 */
  function toast(msg, type='info'){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast show';
    if(type==='error') t.classList.add('error');
    if(type==='success') t.classList.add('success');
    setTimeout(()=>t.className='toast', 2500);
    vibrate(type==='error'?[10,50,10]:[10]);
  }

  function vibrate(pattern){
    if(navigator.vibrate) navigator.vibrate(pattern);
  }

  function comma(n){
    return Number(n||0).toLocaleString('en-US');
  }

  function parseIntClean(s){
    const n = Number(String(s||'').replace(/[^0-9]/g,''));
    return isNaN(n)?0:Math.round(n);
  }

  function formatCommaInput(el){
    const v = parseIntClean(el.value);
    el.value = v ? comma(v) : '';
  }

  function getNat2(code){
    const v = String(code||'').trim().toUpperCase();
    if(!v) return '';
    if(v.length === 2) return v;
    return v.substring(0,2);
  }

  function extractSheetId(input){
    const s = String(input||'').trim();
    if(!s) return '';
    const urlMatch = s.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    if(urlMatch) return urlMatch[1];
    return s;
  }

  /* 새로운 파일명 로직: HHMM_SC###_이름조합 (최대 25자) */
  function buildFilename(hhmm){
    // SC 번호 증가
    state.scCounter++;
    const scNum = String(state.scCounter).padStart(3, '0');

    // 시간 포맷
    const time = String(hhmm || '').padStart(4, '0');

    // 이름 조합 (알파벳 앞 4글자, '_'로 구분)
    const names = Array.from(state.selectedPlayers.values())
      .map(sel => {
        const name = sel.player.player
          .toUpperCase()
          .replace(/[^A-Z]/g, ''); // 알파벳만
        return name.substring(0, 4); // 항상 4글자
      })
      .join('_'); // '_'로 이름 구분

    const filename = `${time}_SC${scNum}_${names}`;

    // 25자 체크
    if (filename.length > 25) {
      const prefix = `${time}_SC${scNum}_`; // 11자
      const maxNames = 25 - prefix.length; // 14자
      return prefix + names.substring(0, maxNames);
    }

    return filename;
  }

  /* 로딩 */
  const loading = {
    show(msg, detail=''){
      document.getElementById('loadingMsg').textContent = msg;
      document.getElementById('loadingDetail').textContent = detail;
      document.getElementById('loadingOverlay').classList.add('show');
    },
    update(current, total){
      document.getElementById('loadingDetail').textContent = `${current}/${total} 처리 중...`;
    },
    hide(){
      document.getElementById('loadingOverlay').classList.remove('show');
    }
  };

  /* 모달 */
  function openSettings(){
    document.getElementById('settingsModal').classList.add('show');
  }
  function closeSettings(){
    document.getElementById('settingsModal').classList.remove('show');
  }

  /* Sheet ID */
  function loadIdsFromLocal(){
    const cue = localStorage.getItem(LS_KEYS.CUE) || '';
    const type = localStorage.getItem(LS_KEYS.TYPE) || '';
    const bb = localStorage.getItem(LS_KEYS.BB) || '';
    const mode = localStorage.getItem(LS_KEYS.MODE) || 'PU';

    if(cue) document.getElementById('cueId').value = cue;
    if(type) document.getElementById('typeId').value = type;
    if(bb) document.getElementById('commonBB').value = bb;

    state.cueId = cue;
    state.typeId = type;
    state.activeMode = mode;

    setActiveMode(mode);
    renderIdsHint();
  }

  function saveIds(){
    const cueRaw = document.getElementById('cueId').value.trim();
    const typeRaw = document.getElementById('typeId').value.trim();

    const cue = extractSheetId(cueRaw);
    const type = extractSheetId(typeRaw);

    if(cue) localStorage.setItem(LS_KEYS.CUE, cue); else localStorage.removeItem(LS_KEYS.CUE);
    if(type) localStorage.setItem(LS_KEYS.TYPE, type); else localStorage.removeItem(LS_KEYS.TYPE);

    state.cueId = cue;
    state.typeId = type;

    renderIdsHint();
    toast('설정 저장 완료', 'success');
    closeSettings();
    reloadSheets();
  }

  function clearIds(){
    localStorage.removeItem(LS_KEYS.CUE);
    localStorage.removeItem(LS_KEYS.TYPE);
    state.cueId = '';
    state.typeId = '';
    document.getElementById('cueId').value = '';
    document.getElementById('typeId').value = '';
    renderIdsHint();
    toast('설정 초기화 완료', 'success');
  }

  function renderIdsHint(){
    const c = state.cueId ? `CUE=${state.cueId.substring(0,8)}...` : 'CUE=기본값';
    const t = state.typeId ? `TYPE=${state.typeId.substring(0,8)}...` : 'TYPE=기본값';
    document.getElementById('idsHint').textContent = `${c} | ${t}`;
  }

  /* 모드 */
  function setActiveMode(mode){
    state.activeMode = mode;
    localStorage.setItem(LS_KEYS.MODE, mode);

    ['PU','ELIM','L3'].forEach(m=>{
      const btn = document.getElementById(`modeBtn_${m}`);
      btn.className = 'mode-btn';
      if(m === mode){
        if(m==='PU') btn.classList.add('active-pu');
        else if(m==='ELIM') btn.classList.add('active-elim');
        else if(m==='L3') btn.classList.add('active-l3');
      }
    });

    vibrate([5]);
  }

  /* 데이터 */
  function indexTypeRows(rows){
    state.byRoom = {};
    state.byRoomTable = {};
    rows.forEach(r=>{
      (state.byRoom[r.room] ||= []).push(r);
      const key = r.room + '|' + r.tno;
      (state.byRoomTable[key] ||= []).push(r);
    });
  }

  function fillRooms(){
    const sel = document.getElementById('selRoom');
    sel.innerHTML = '<option value="">Room</option>';
    [...new Set(Object.keys(state.byRoom))].sort().forEach(v=>{
      const o = document.createElement('option');
      o.value = o.textContent = v;
      sel.appendChild(o);
    });
  }

  function fillTables(){
    const room = document.getElementById('selRoom').value;
    const sel = document.getElementById('selTableNo');
    sel.innerHTML = '<option value="">Table</option>';
    const arr = state.byRoom[room]||[];
    const uniq = [...new Set(arr.map(r=>String(r.tno).trim()))].sort((a,b)=>Number(a)-Number(b));
    uniq.forEach(v=>{
      const o = document.createElement('option');
      o.value = o.textContent = v;
      sel.appendChild(o);
    });
    renderPlayerGrid();
  }

  function fillTimes(list, center){
    const sel = document.getElementById('selTime');
    sel.innerHTML = '<option value="">자동</option>';
    list.forEach(v=>{
      const o = document.createElement('option');
      o.value = v;
      o.textContent = (v===center) ? `${v} ← 현재` : v;
      sel.appendChild(o);
    });
  }

  /* 플레이어 그리드 */
  function renderPlayerGrid(){
    const room = document.getElementById('selRoom').value;
    const tno = document.getElementById('selTableNo').value;

    if(!room || !tno){
      document.getElementById('playerGrid').innerHTML = '';
      document.getElementById('selectedList').innerHTML = '<div class="empty-state">테이블을 선택하세요</div>';
      return;
    }

    const players = state.byRoomTable[room+'|'+tno] || [];
    if(players.length === 0){
      document.getElementById('playerGrid').innerHTML = '';
      document.getElementById('selectedList').innerHTML = '<div class="empty-state">플레이어가 없습니다</div>';
      return;
    }

    const sorted = players.slice().sort((a,b)=>Number(a.seat.replace('#',''))-Number(b.seat.replace('#','')));

    // 최대 9명만 표시 (포커 테이블 최대 인원)
    const displayPlayers = sorted.slice(0, 9);

    // 9개 슬롯 생성 (빈 슬롯 포함)
    const slots = [];
    for(let i = 0; i < 9; i++){
      if(i < displayPlayers.length){
        const p = displayPlayers[i];
        const pid = `${room}_${tno}_${p.seat}`;
        const sel = state.selectedPlayers.get(pid);
        let cls = 'player-pill';
        if(sel){
          if(sel.mode==='PU') cls += ' selected-pu';
          else if(sel.mode==='ELIM') cls += ' selected-elim';
          else if(sel.mode==='L3') cls += ' selected-l3';
        }

        const shortName = p.player.split(' ')[0] || p.player;
        slots.push(`<div class="${cls}" onclick="togglePlayer('${pid}')" title="${p.player} / ${p.nat}">${shortName}</div>`);
      } else {
        // 빈 슬롯
        slots.push(`<div class="player-pill" style="opacity:0.3; cursor:default;">-</div>`);
      }
    }

    document.getElementById('playerGrid').innerHTML = slots.join('');

    renderSelectedList();
  }

  function togglePlayer(pid){
    const room = document.getElementById('selRoom').value;
    const tno = document.getElementById('selTableNo').value;
    const player = (state.byRoomTable[room+'|'+tno] || []).find(p=>`${room}_${tno}_${p.seat}`===pid);

    if(!player) return;

    if(state.selectedPlayers.has(pid)){
      state.selectedPlayers.delete(pid);
    } else {
      state.selectedPlayers.set(pid, {
        player,
        mode: state.activeMode,
        data: {}
      });
    }

    vibrate([10]);
    renderPlayerGrid();
    updateBadge();
  }

  function removePlayer(pid){
    state.selectedPlayers.delete(pid);
    vibrate([10]);
    renderPlayerGrid();
    updateBadge();
  }

  function updatePlayerData(pid){
    const sel = state.selectedPlayers.get(pid);
    if(!sel) return;

    if(sel.mode === 'PU'){
      sel.data.stack = document.getElementById(`stack_${pid}`)?.value || '';
      // BB만 업데이트 (renderSelectedList 호출하지 않음)
      const bb = parseIntClean(document.getElementById('commonBB').value);
      const stackNum = parseIntClean(sel.data.stack);
      const bbCalc = (stackNum>0 && bb>0) ? Math.round(stackNum/bb) : '';
      const bbSpan = document.querySelector(`#stack_${pid} + .card-bb`);
      if(bbSpan) bbSpan.textContent = bbCalc ? bbCalc+'BB' : '';
    } else if(sel.mode === 'ELIM'){
      const prevPrizeYN = sel.data.prizeYN;
      sel.data.prizeYN = document.getElementById(`prizeYN_${pid}`)?.value || '';
      sel.data.prizeAmt = document.getElementById(`prizeAmt_${pid}`)?.value || '';

      // 상금 유/무가 변경될 때만 재렌더링 (입력창 표시/숨김)
      if(prevPrizeYN !== sel.data.prizeYN) {
        renderSelectedList();
      }
    }
  }

  function updateBadge(){
    const count = state.selectedPlayers.size;
    document.getElementById('headerBadge').textContent = count;
    document.getElementById('sendBtnText').textContent = count > 0 ? `${count}명 전송` : '전송';
  }

  /* 선택 리스트 */
  function renderSelectedList(){
    const list = document.getElementById('selectedList');

    if(state.selectedPlayers.size === 0){
      list.innerHTML = '<div class="empty-state">플레이어를 선택하세요</div>';
      return;
    }

    const items = Array.from(state.selectedPlayers.entries()).map(([pid, sel])=>{
      const p = sel.player;
      const mode = sel.mode;

      let modeClass = 'selected-card';
      if(mode==='PU') modeClass += ' mode-pu';
      else if(mode==='ELIM') modeClass += ' mode-elim';
      else if(mode==='L3') modeClass += ' mode-l3';

      let fields = '';
      if(mode === 'PU'){
        const bb = parseIntClean(document.getElementById('commonBB').value);
        const stackVal = sel.data.stack || '';
        const stackNum = parseIntClean(stackVal);
        const bbCalc = (stackNum>0 && bb>0) ? Math.round(stackNum/bb) : '';

        fields = `
          <div class="card-input">
            <input type="text" id="stack_${pid}" placeholder="스택" inputmode="numeric"
                   value="${stackVal}" oninput="formatCommaInput(this); updatePlayerData('${pid}')" />
            <span class="card-bb">${bbCalc?bbCalc+'BB':''}</span>
          </div>
        `;
      } else if(mode === 'ELIM'){
        fields = `
          <div class="card-input">
            <select id="prizeYN_${pid}" onchange="updatePlayerData('${pid}')">
              <option value="">상금</option>
              <option value="유" ${sel.data.prizeYN==='유'?'selected':''}>유</option>
              <option value="무" ${sel.data.prizeYN==='무'?'selected':''}>무</option>
            </select>
          </div>
          ${sel.data.prizeYN==='유'?`
          <div class="card-input">
            <input type="text" id="prizeAmt_${pid}" placeholder="상금 금액" inputmode="numeric"
                   value="${sel.data.prizeAmt||''}" oninput="formatCommaInput(this); updatePlayerData('${pid}')" />
          </div>
          `:''}
        `;
      } else if(mode === 'L3'){
        fields = `<div class="card-hint">프로필 자막: 이름만 사용</div>`;
      }

      return `
        <div class="${modeClass}">
          <div class="card-header">
            <div class="card-name">${p.player} / ${p.nat}</div>
            <div class="card-remove" onclick="removePlayer('${pid}')">×</div>
          </div>
          ${fields}
        </div>
      `;
    }).join('');

    list.innerHTML = items;
  }

  /* 전송 */
  async function send(){
    if(state.isProcessing){
      toast('이미 전송 중입니다', 'error');
      return;
    }

    if(state.selectedPlayers.size === 0){
      toast('플레이어를 선택하세요', 'error');
      return;
    }

    const bbRaw = document.getElementById('commonBB').value;
    const bbValue = parseIntClean(bbRaw);

    for(const [pid, sel] of state.selectedPlayers.entries()){
      if(sel.mode === 'PU'){
        if(!sel.data.stack){
          toast(`${sel.player.player}의 스택을 입력하세요`, 'error');
          return;
        }
        if(!bbValue){
          toast('Big Blind를 입력하세요', 'error');
          return;
        }
      }
      if(sel.mode === 'ELIM'){
        if(!sel.data.prizeYN){
          toast(`${sel.player.player}의 상금 유/무를 선택하세요`, 'error');
          return;
        }
        if(sel.data.prizeYN === '유' && !sel.data.prizeAmt){
          toast(`${sel.player.player}의 상금 금액을 입력하세요`, 'error');
          return;
        }
      }
    }

    if(bbRaw) localStorage.setItem(LS_KEYS.BB, bbRaw);

    state.isProcessing = true;
    const autoNow = document.getElementById('chkAuto').checked;
    const picked = document.getElementById('selTime').value;
    const hhmm = picked ? picked.replace(':','') : (state.timeCenter||'').slice(0,5).replace(':','');

    // 새로운 파일명 생성
    const filename = buildFilename(hhmm);

    const items = [];
    for(const [pid, sel] of state.selectedPlayers.entries()){
      const p = sel.player;
      let block = `${p.player.toUpperCase()} / ${getNat2(p.nat)}`;

      if(sel.mode === 'PU'){
        const stackRaw = parseIntClean(sel.data.stack);
        const bbCalc = (stackRaw>0 && bbValue>0) ? Math.round(stackRaw/bbValue) : '';
        block += `\nCURRENT STACK - ${sel.data.stack.toUpperCase()} (${bbCalc}BB)`;
      } else if(sel.mode === 'ELIM'){
        block += '\nELIMINATED';
        if(sel.data.prizeYN === '유' && sel.data.prizeAmt) {
          block += `\n${sel.data.prizeAmt.toUpperCase()}`;
        }
      } else if(sel.mode === 'L3'){
        block = `프로필 자막\n${p.player.toUpperCase()}`;
      }

      items.push({
        kind: sel.mode,
        playerName: p.player,
        nat: getNat2(p.nat),
        cueId: state.cueId || undefined,
        pickedTime: picked,
        autoNow,
        tz: state.tz,
        eFix: '미완료',
        gFix: 'SOFT',
        filename: filename, // 모든 플레이어에게 동일한 파일명
        jBlock: block
      });
    }

    loading.show('전송 중...', `${items.length}명 일괄 전송`);

    try {
      const res = await sendBatchAsync(items);
      loading.hide();
      state.isProcessing = false;

      if(res?.ok){
        const successCount = res.successCount || items.length;
        const failCount = res.failCount || 0;

        if(failCount === 0){
          toast(`✅ ${successCount}개 전송 완료 (${filename})`, 'success');
          state.selectedPlayers.clear();
          renderPlayerGrid();
          updateBadge();
        } else {
          toast(`⚠️ ${successCount}개 성공, ${failCount}개 실패`, 'error');
        }
      } else {
        toast(`전송 실패: ${res?.error || '알 수 없는 오류'}`, 'error');
      }
    } catch(err){
      loading.hide();
      state.isProcessing = false;
      console.error('전송 오류:', err);
      toast(`전송 오류: ${err.message || '알 수 없는 오류'}`, 'error');
    }
  }

  function sendBatchAsync(items){
    return new Promise((resolve, reject)=>{
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .updateVirtualBatch(items);
    });
  }

  /* 데이터 로드 */
  function reloadSheets(){
    google.script.run.withSuccessHandler(res=>{
      if(res?.ok){
        state.timeCenter = res.center || '';
        fillTimes(res.list||[], res.center||'');
      }
    }).getTimeOptions(state.cueId || null);

    google.script.run.withSuccessHandler(res=>{
      if(res?.ok){
        state.typeRows = res.rows||[];
        indexTypeRows(state.typeRows);
        fillRooms();
      }
    }).getTypeRows(state.typeId || null);

    google.script.run.withSuccessHandler(res=>{
      state.countryMap = (res && res.ok && res.map) ? res.map : {};
    }).getCountryMap(state.typeId || null);
  }

  function init(){
    google.script.run.withSuccessHandler(info=>{
      state.tz = info?.tz || 'Asia/Seoul';
    }).getBootstrap();

    loadIdsFromLocal();
    reloadSheets();

    document.getElementById('commonBB').addEventListener('input', function(){
      formatCommaInput(this);
      localStorage.setItem(LS_KEYS.BB, this.value);
      renderSelectedList();
    });

    document.getElementById('selRoom').addEventListener('change', fillTables);
    document.getElementById('selTableNo').addEventListener('change', renderPlayerGrid);
  }

  window.addEventListener('load', init);

</script>
</body>
</html>
