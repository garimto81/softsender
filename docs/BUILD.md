# Build System Documentation

## 📌 개요

Google Apps Script (GAS) Web App 배포를 위한 Node.js 기반 빌드 시스템입니다.

## 🎯 왜 빌드 시스템이 필요한가?

### 문제점
1. **GAS 런타임 Include의 성능 이슈**
   - `<?!= include('file') ?>` 방식은 런타임에 파일을 로드 (느림)
   - 배포 시 체감 가능한 성능 저하 발생

2. **단일 파일 관리의 어려움**
   - 현재 `page.html`: 1,097줄
   - HTML, CSS, JavaScript가 모두 섞여 있음
   - 코드 탐색, 수정, 유지보수 어려움

3. **코드 재사용성 부족**
   - 함수별 모듈화 불가능
   - 테스트 어려움

### 해결책: 빌드 타임 번들링
- **개발 시**: 파일을 모듈별로 분리하여 작업
- **배포 시**: Node.js 스크립트로 단일 HTML 파일로 병합
- **결과**: 개발 생산성 ↑, 배포 성능 ↑

---

## 📂 프로젝트 구조

```
softsender/
├── src/                           # 개발 소스 (분리된 파일)
│   ├── template.html              # HTML 템플릿 (마크업만)
│   ├── styles.css                 # CSS 스타일
│   ├── constants.js               # 상수 정의
│   ├── utils.js                   # 유틸리티 함수
│   ├── preview.js                 # 미리보기 로직
│   ├── batch.js                   # 배치 전송 기능
│   ├── events.js                  # 이벤트 핸들러
│   └── init.js                    # 초기화 로직
│
├── dist/                          # 빌드 출력 (배포용)
│   └── page.html                  # 병합된 단일 파일 ← GAS에 업로드
│
├── build.js                       # 빌드 스크립트
├── package.json                   # npm 설정
├── softsender_code.gs             # GAS 서버 코드 (변경 없음)
└── docs/
    ├── BUILD.md                   # 이 문서
    ├── PRD.md
    ├── LLD.md
    └── FEATURE_ENHANCEMENT_PLAN.md
```

---

## 🚀 사용 방법

### 1. 초기 설정 (최초 1회)

```bash
# Node.js 패키지 설치
npm install
```

### 2. 개발 워크플로우

#### Option A: 자동 빌드 (권장)
```bash
# 파일 변경 감지 → 자동 빌드
npm run dev
```

- `src/` 폴더의 파일 수정 → 자동으로 `dist/page.html` 재생성
- 개발하는 동안 계속 실행

#### Option B: 수동 빌드
```bash
# 한 번만 빌드
npm run build
```

#### Option C: 배포용 최적화 빌드
```bash
# 주석 제거 + 압축
npm run build:min
```

### 3. 배포 프로세스

```
1. npm run build:min (최적화 빌드)
   ↓
2. dist/page.html 열기
   ↓
3. 전체 내용 복사 (Ctrl+A → Ctrl+C)
   ↓
4. Google Apps Script 프로젝트의 page.html에 붙여넣기
   ↓
5. 배포 → 새 배포 (또는 기존 배포 관리)
   ↓
6. 완료 ✅
```

---

## 📝 소스 파일 설명

### `src/template.html`
- HTML 마크업만 포함
- 주석으로 주입 위치 표시:
```html
<!DOCTYPE html>
<html>
<head>
  <title>Soft Content Sender</title>
  <!-- INJECT:CSS -->
</head>
<body>
  <!-- HTML 마크업 -->

  <script>
    // INJECT:CONSTANTS
    // INJECT:UTILS
    // INJECT:PREVIEW
    // INJECT:BATCH
    // INJECT:EVENTS
    // INJECT:INIT
  </script>
</body>
</html>
```

### `src/styles.css`
- 모든 CSS 스타일
- `<!-- INJECT:CSS -->` 위치에 `<style>` 태그로 주입

### `src/constants.js`
- `CONSTANTS` 객체
- 모드, 타입, 메시지 등 상수 정의

### `src/utils.js`
- `formatCommas()`, `parseIntClean()`, `formatKM()` 등
- 순수 함수들 (독립적으로 테스트 가능)

### `src/preview.js`
- `generateCurrentPreview()`, `generatePreview()` 등
- 미리보기 생성 로직

### `src/batch.js`
- `addToBatch()`, `sendBatch()`, `renderBatchList()` 등
- 배치 전송 기능

### `src/events.js`
- `handleModeChange()`, `handleTableChange()` 등
- 이벤트 핸들러 함수

### `src/init.js`
- `initializeApp()`, `initEventDelegation()` 등
- 초기화 로직

---

## ⚙️ 빌드 스크립트 동작 원리

### `build.js` 핵심 로직

```javascript
const fs = require('fs');
const path = require('path');

// 1. 소스 파일 읽기
const html = fs.readFileSync('src/template.html', 'utf-8');
const css = fs.readFileSync('src/styles.css', 'utf-8');
const constants = fs.readFileSync('src/constants.js', 'utf-8');
// ... 기타 파일

// 2. 템플릿 치환
const merged = html
  .replace('<!-- INJECT:CSS -->', `<style>${css}</style>`)
  .replace('// INJECT:CONSTANTS', constants)
  .replace('// INJECT:UTILS', utils)
  // ... 기타 주입

// 3. 빌드 정보 주석 추가
const buildInfo = `
<!--
  Build Time: ${new Date().toISOString()}
  Build Version: v10.1
  Auto-generated - DO NOT EDIT THIS FILE DIRECTLY
  Edit source files in src/ and run 'npm run build'
-->
`;

// 4. 파일 저장
fs.writeFileSync('dist/page.html', buildInfo + merged);
```

---

## 🔧 package.json 스크립트

```json
{
  "scripts": {
    "dev": "nodemon --watch src --exec \"node build.js\"",
    "build": "node build.js",
    "build:min": "node build.js --minify"
  },
  "devDependencies": {
    "nodemon": "^3.0.0"
  }
}
```

### 스크립트 설명
- **dev**: `src/` 폴더 감시 → 변경 시 자동 빌드
- **build**: 일반 빌드 (주석 포함)
- **build:min**: 최적화 빌드 (주석 제거, 압축)

---

## 🔍 고급 기능 (선택사항)

### 1. Git Pre-commit Hook
커밋 전 자동 빌드:
```bash
# .git/hooks/pre-commit
#!/bin/sh
npm run build
git add dist/page.html
```

### 2. 조건부 컴파일
```javascript
// src/utils.js
// #if DEBUG
console.log('Debug mode active');
// #endif

// build.js에서 --minify 옵션 시 제거
```

### 3. 로컬 개발 서버
```bash
# 실시간 미리보기
npm install -g live-server
live-server dist/
```

---

## 📊 빌드 결과 비교

| 항목 | 기존 (단일 파일) | 빌드 시스템 |
|------|-----------------|------------|
| 개발 편의성 | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| 코드 탐색 | 어려움 (1097줄) | 쉬움 (모듈별 50-200줄) |
| 재사용성 | 낮음 | 높음 (독립 함수) |
| 테스트 | 불가능 | 가능 (모듈별 테스트) |
| 배포 성능 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ (동일) |
| 배포 속도 | 빠름 | 빠름 (빌드 타임 병합) |

---

## ⚠️ 주의사항

### 1. 배포 파일 직접 수정 금지
❌ **절대 하지 마세요**:
```
dist/page.html 직접 수정
```

✅ **올바른 방법**:
```
1. src/ 폴더의 해당 파일 수정
2. npm run build 실행
3. dist/page.html 확인
```

### 2. GAS 업로드 파일
- **업로드할 파일**: `dist/page.html` (빌드된 파일)
- **업로드하지 말 것**: `src/` 폴더의 개별 파일

### 3. Git 관리
```gitignore
# .gitignore
node_modules/
dist/page.html    # 빌드 산출물은 제외 (선택사항)
```

---

## 🐛 트러블슈팅

### Q1: `npm run dev` 실행 시 오류
```bash
# nodemon 설치 확인
npm install nodemon --save-dev
```

### Q2: 빌드된 파일에 변경사항이 반영 안됨
```bash
# 캐시 삭제 후 재빌드
rm -rf dist/
npm run build
```

### Q3: GAS에서 동작 안함
- `dist/page.html`의 빌드 정보 주석 확인
- `<?= ... ?>` 태그 없는지 확인 (순수 HTML만)
- 브라우저 콘솔에서 에러 확인

---

## 📈 성능 비교

### GAS Include 방식 (기존, 사용 안함)
```html
<?!= include('styles') ?>
<?!= include('scripts') ?>
<!-- 런타임 로드 → 느림 -->
```

### 빌드 시스템 (현재)
```html
<style>/* 모든 CSS가 이미 병합됨 */</style>
<script>/* 모든 JS가 이미 병합됨 */</script>
<!-- 빌드 타임 병합 → 빠름 -->
```

**결과**: 배포 후 로딩 속도 동일하게 빠름 ✅

---

## 🎓 학습 자료

### Node.js 파일 시스템
- `fs.readFileSync()`: 파일 읽기
- `fs.writeFileSync()`: 파일 쓰기
- `path.join()`: 경로 조합

### 템플릿 치환
```javascript
string.replace('placeholder', 'actual content')
```

### Watch 모드
- `nodemon`: 파일 변경 감지 도구
- `--watch src`: `src/` 폴더 감시

---

## 📅 버전 히스토리

- **v1.0** (2025-10-05): 초기 빌드 시스템 구축
  - 기본 파일 분리 구조
  - 빌드 스크립트 구현
  - Watch 모드 지원

---

## 🔗 관련 문서

- [PRD.md](PRD.md) - 제품 요구사항
- [LLD.md](LLD.md) - 기술 설계
- [README.md](../README.md) - 프로젝트 개요

---

**작성일**: 2025-10-05
**버전**: v1.0
**유지보수**: 빌드 시스템 변경 시 이 문서 업데이트
