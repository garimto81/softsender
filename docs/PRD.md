# PRD (Product Requirement Document)
# Soft Content Sender - 포커 방송 자막 관리 시스템

## 📋 문서 정보
- **작성일**: 2025-10-04
- **최종 수정**: 2025-01-16
- **버전**: v11.8.3
- **대상 사용자**: 포커 토너먼트 방송 제작팀

---

## 1. 제품 개요

### 1.1 목적
포커 토너먼트 생중계 방송에서 **서브 테이블(비방송 테이블)의 자막 콘텐츠를 쉽고 빠르게 생성하고 관리**하는 웹 애플리케이션입니다.

> **시스템 범위**: 방송에 노출되는 피처 테이블(Feature Table)은 별도 시스템에서 관리. 본 시스템은 대회장 내 여러 서브 테이블의 플레이어 정보를 빠르게 자막화하는 데 집중.

### 1.2 해결하는 문제
- 대회장 내 여러 서브 테이블의 플레이어 정보를 실시간으로 자막화
- 칩스택 업데이트, 탈락 정보, 프로필, 리더보드 등 다양한 자막 필요
- 수동으로 자막을 만들면 시간이 오래 걸리고 오타 발생 가능
- 브레이크마다 여러 서브 테이블을 빠르게 처리해야 함

### 1.3 핵심 가치
✅ **빠른 작업**: 클릭 몇 번으로 자막 생성
✅ **정확성**: 데이터베이스에서 플레이어 정보 자동 로드
✅ **실시간**: 현재 시각 기준으로 스프레드시트에 즉시 반영
✅ **편리성**: 모바일/태블릿에서도 사용 가능한 반응형 디자인

---

## 2. 주요 기능

### 2.1 자막 타입 (4가지 모드)

#### 📊 PU (Player Update) - 플레이어 업데이트
- **목적**: 플레이어의 현재 칩스택을 화면에 표시
- **입력 정보**:
  - 플레이어 이름
  - 국가 (풀네임)
  - 칩스택 금액 (예: 1,234,000)
  - Big Blind 값 (예: 20,000)
- **자동 계산**: BB (Big Blind) 단위로 환산 (예: 62BB)
- **출력 예시**:
  ```
  UNITED STATES OF AMERICA
  JOHN DOE
  CURRENT STACK - 1,234,000 (62BB)
  ```

#### ❌ ELIM (Elimination) - 탈락 정보 (v9 업데이트)
- **목적**: 토너먼트에서 탈락한 플레이어 정보 표시
- **입력 정보**:
  - 플레이어 이름
  - 국가 (2자리 코드: US, KR 등)
  - 상금 여부 선택
  - 상금 있을 시: 순위 + 금액 입력
- **출력 예시**:
  - 상금 없음:
    ```
    KIM MINSU / KR
    ELIMINATED
    ```
  - 상금 있음:
    ```
    JOHN DOE / US
    ELIMINATED IN 5TH PLACE ($10000)
    ```

#### 👤 L3 (Lower Third) - 플레이어 소개
- **목적**: 플레이어 소개 자막
- **입력 정보**: 플레이어 이름
- **출력 예시**:
  ```
  플레이어 소개
  JOHN DOE
  ```

#### 🏆 LEADERBOARD - 리더보드
- **목적**: 테이블 전체 칩스택 순위 표시
- **입력 정보**:
  - 레벨 (Level)
  - SB/BB/ANTE (블라인드 정보)
  - 각 플레이어별 칩스택
- **자동 처리**:
  - 칩스택 많은 순으로 자동 정렬
  - 이름을 "이니셜. 성" 형식으로 변환 (예: John Doe → J. DOE)
  - 블라인드를 K/M 단위로 변환 (예: 50,000 → 50K, 2,000,000 → 2M)
- **출력 예시**:
  ```
  J. DOE    4,190,000
  K. LEE    3,850,000
  M. SMITH  2,100,000

  LV 15 | BLINDS 25K / 50K - 50K
  ```

---

## 3. 사용 흐름

### 3.1 기본 워크플로우 (단일 전송)

```
1. 웹 앱 접속
   ↓
2. Sheet ID 설정 (처음 1회만, 이후 자동 저장)
   ↓
3. 모드 선택 (PU/ELIM/L3/LEADERBOARD)
   ↓
4. 테이블 선택 (Room+Table 통합: "PokerStars - Final Table")
   ↓
5. 좌석/플레이어 선택 ("#1 - John Doe" 형식) → 정보 자동 로드
   ↓
6. 필요한 정보 입력
   - PU: 칩스택, Big Blind
   - ELIM: 상금 여부, 순위/금액 (상금 있을 시)
   ↓
7. 미리보기 확인
   ↓
8. 전송 버튼 클릭
   ↓
9. Google 스프레드시트에 자동 업데이트 ✅
```

### 3.2 배치 전송 워크플로우 (v10 신규)

```
1. 모드 선택 (PU/ELIM/L3)
   ↓
2. 플레이어 1 선택 + 정보 입력
   ↓
3. [➕ 배치에 추가] 버튼 클릭 → 자동으로 다음 좌석 이동
   ↓
4. 플레이어 2 선택 + 모드 변경 가능 + 정보 입력
   ↓
5. [➕ 배치에 추가] 반복 (Ctrl+B 단축키 사용 가능)
   ↓
6. 배치 대기 중 섹션에서 추가된 항목 확인
   ↓
7. 통합 미리보기 확인 (배치 N건 + 현재 입력)
   ↓
8. [📤 배치 전송 (N건)] 버튼 클릭
   ↓
9. 한 번의 서버 호출로 모든 데이터 전송 ✅
```

### 3.3 시간 선택 방식
- **자동 모드 (기본)**: 현재 시각(KST)에 해당하는 행에 자동 기록
- **수동 모드**: ±20분 범위 내 시간 중 선택 가능

---

## 4. 데이터 구조

### 4.1 연결되는 Google 스프레드시트

#### 📌 CUE Sheet (방송 큐시트)
- **탭**: `virtual`
- **역할**: 방송 타임라인별로 자막 콘텐츠 저장
- **주요 컬럼**:
  - C열: 시간 (예: 17:42) - 참조용
  - E열: 상태 (미완료/완료) - 참조용
  - F열: 파일명 - 자동 생성
  - G열: 타입 (SOFT) - 자동 입력
  - J열: 자막 내용 - 자동 입력
  - K열: 소프트 콘텐츠 종류 - 자동 입력 (2줄 형식)
    - 1줄: "소프트 콘텐츠"
    - 2줄: "'플레이어 업데이트'" 또는 "'플레이어 소개'"

#### 📌 TYPE Sheet (플레이어 데이터)
- **탭**: `Type`
- **역할**: 테이블별 플레이어 정보 저장
- **주요 컬럼**:
  - Poker Room: 포커룸 이름
  - Table Name: 테이블 이름
  - Table No.: 테이블 번호
  - Seat No.: 좌석 번호 (예: #1, #2)
  - Players: 플레이어 이름
  - Nationality: 국가 코드 (예: KR, US)

- **탭**: `CountryMap`
- **역할**: 국가 코드 → 풀네임 변환
- **구조**:
  - Code: 국가 코드 (예: KR, US)
  - Name: 풀네임 (예: South Korea, United States of America)

---

## 5. 주요 기술 스펙

### 5.1 기술 스택
- **Frontend**: HTML, CSS, JavaScript (순수 바닐라)
- **Backend**: Google Apps Script (서버리스)
- **Database**: Google Sheets (스프레드시트)
- **Hosting**: Google Apps Script Web App

### 5.2 핵심 기능
- 반응형 디자인 (모바일/태블릿/데스크톱)
- 로컬 스토리지 (Sheet ID 저장)
- 실시간 미리보기
- 자동 계산 (BB, 칩스택 정렬 등)
- 에러 처리 및 사용자 피드백 (토스트 메시지)

---

## 6. 사용자 인터페이스

### 6.1 디자인 컨셉
- **다크 테마**: 방송 현장 환경에 맞춘 어두운 배경
- **큰 터치 영역**: 모바일/태블릿 사용 고려 (64px 높이)
- **명확한 구분**: 섹션별 패널 구분
- **실시간 피드백**: 입력 시 즉시 미리보기 갱신

### 6.2 주요 UI 컴포넌트
- **헤더**: 타이틀 + 상태 표시
- **Sheet ID 섹션**: ID 입력 + 저장/초기화 버튼
- **시간 선택**: 자동/수동 토글 + 드롭다운
- **모드 탭**: 4가지 모드 버튼
- **드롭다운**: Room → Table → Seat 계층 구조
- **입력 필드**: 모드별 동적 표시
- **미리보기**: 실시간 자막 내용 표시
- **토스트 메시지**: 성공/실패 알림

---

## 7. 파일 이름 규칙

### 7.1 형식
```
HHmm_이름_모드
```

### 7.2 예시
- PU: `1742_John_Doe_PU`
- ELIM: `1742_Kim_Minsu_ELIM`
- L3: `1742_John_Doe_L3`
- LEADERBOARD: `1742_Table7_LEADERBOARD`

### 7.3 규칙
- HHmm: 24시간 형식 (예: 17:42 → 1742)
- 이름: 영문, 언더스코어로 공백 대체
- 모드: PU, ELIM, L3, LEADERBOARD, SC(기타)

---

## 8. 비기능 요구사항

### 8.1 성능
- 페이지 로딩 시간: 3초 이내
- 전송 응답 시간: 2초 이내
- 드롭다운 렌더링: 1초 이내

### 8.2 안정성
- 네트워크 오류 시 명확한 에러 메시지
- 잘못된 입력 방지 (유효성 검사)
- Sheet 권한 오류 처리

### 8.3 사용성
- 직관적인 워크플로우
- 최소 클릭으로 작업 완료
- 명확한 피드백 메시지

---

## 9. v10~v10.1 신규 기능 (2025-10-05 구현 완료)

### 9.1 배치 전송 (Batch Builder) - v10
✅ **구현 완료** - 서브 테이블 전체를 한 번에 처리
**PLAN 근거**: [시나리오 L56-66 - 브레이크 타임 서브 테이블 업데이트](PLAN.md#L56), [성공기준 L89 - 배치 1개 테이블 ≤90초](PLAN.md#L89)

- 플레이어별로 배치 목록에 추가
- 각 플레이어마다 다른 모드 선택 가능 (PU/ELIM/L3 조합)
- 한 번의 서버 호출로 모든 데이터 전송
- 자동 다음 좌석 이동
- 배치 대기 중 섹션에서 시각적 확인

### 9.2 스마트 전송 버튼 - v10.1
✅ **구현 완료** - 단일/배치 자동 감지
**PLAN 근거**: [핵심 원칙 L124 - 속도 우선, 모든 작업 ≤3클릭](PLAN.md#L124)

- 배치 항목 있으면 자동으로 "📤 배치 전송 (N건)" 표시
- 전송 버튼 1개로 통합 (혼란 제거)
- 배치 리스트 자동 표시/숨김

### 9.3 통합 미리보기 - v10.1
✅ **구현 완료** - 배치 + 현재 입력 함께 표시
**PLAN 근거**: [핵심 원칙 L128 - 실시간 피드백](PLAN.md#L128)

### 9.4 실시간 미리보기 자동 갱신 - v10.1
✅ **구현 완료** - 사용자 액션 불필요
**PLAN 근거**: [핵심 원칙 L128 - 입력 즉시 미리보기 갱신](PLAN.md#L128)

- 모든 입력 필드에 자동 갱신 연결
- 300ms 디바운싱으로 성능 최적화
- "미리보기 갱신" 버튼 제거 (불필요)

### 9.5 버튼 배치 최적화 - v10.1
✅ **구현 완료** - 입력 → 액션 동선 최소화
**PLAN 근거**: [핵심 원칙 L124 - 모든 작업 ≤3클릭](PLAN.md#L124)

- [배치 추가] [전송] 버튼을 입력 필드 바로 아래 배치
- 스크롤 없이 바로 클릭 가능
- 시각적 흐름 개선 (입력 → 액션 → 결과)

### 9.6 빌드 시스템 도입 - v10.1
✅ **구현 완료** - 개발/배포 분리
**기술 결정**: 소스 파일 분리로 유지보수성 향상, 빌드 최적화로 로딩 속도 개선

- Node.js 기반 모듈 번들링 (의존성 0개)
- 소스 파일 8개로 분리 (template, styles, constants, utils, preview, batch, events, init)
- 빌드 스크립트 (npm run build, build:min, dev)
- 최적화 빌드: 11% 크기 감소 (37.6KB → 33.6KB)
- Watch 모드 지원 (파일 변경 시 자동 빌드)

---

## 10. 빌드 및 배포 전략 (v11.0 - 2025-10-07 구축 완료)

### 10.1 빌드 시스템
✅ **프론트/백엔드 분리 빌드 파이프라인**

**프론트엔드**: `npm run build:frontend`
- 입력: `src/frontend/**`
- 출력: `dist/page.html` + `page.html`
- 최적화: CSS/JS 압축, 환경 설정 주입

**백엔드**: `npm run build:backend`
- 입력: `softsender_code.gs`
- 출력: `dist/Code.gs`
- 검증: 보안 체크, Sheet ID 검출

**상세**: [BUILD_STRATEGY.md](./BUILD_STRATEGY.md)

### 10.2 환경별 설정
✅ **config/ 폴더 기반 환경 관리**
- `dev.json` - 개발 (디버깅 ON)
- `prod.json` - 프로덕션 (Script Properties)

---

## 11. 향후 개선 사항 (Future Roadmap)

### 11.1 기능 개선
- [ ] 이전 전송 내역 조회
- [ ] 자막 스타일 프리셋
- [ ] 배치 항목 순서 변경

### 11.2 UX 개선
- [x] 키보드 단축키 지원 (Ctrl+B)
- [ ] 다크/라이트 모드 토글
- [ ] 다국어 지원 (한/영)

### 11.3 배포 자동화 (v12.0)
- [ ] clasp 도입
- [ ] 자동 배포 스크립트
- [ ] CI/CD (GitHub Actions)

### 11.4 통합 (Phase 3)
- [ ] OBS Studio 플러그인 연동
- [ ] Slack/Discord 알림
- [ ] 자동 백업 기능

---

## 11. 용어집

| 용어 | 설명 |
|------|------|
| **CUE Sheet** | 방송 큐시트, 타임라인별 작업 내용을 정리한 시트 |
| **TYPE Sheet** | 플레이어 정보 데이터베이스 |
| **Big Blind (BB)** | 포커에서 가장 큰 강제 베팅 금액, 칩스택 단위로도 사용 |
| **칩스택** | 플레이어가 보유한 칩의 총 금액 |
| **Lower Third (L3)** | 화면 하단 1/3 영역에 표시되는 자막 (주로 이름/직업 소개) |
| **플레이어 업데이트 (PU)** | 플레이어의 현재 칩스택을 표시하는 자막 |
| **플레이어 소개 (L3)** | 플레이어 프로필을 소개하는 자막 |
| **LEADERBOARD** | 순위표, 칩스택 순으로 플레이어 나열 |
| **Poker Room** | 포커 토너먼트가 열리는 장소/브랜드 |
| **ANTE** | 포커에서 모든 플레이어가 내는 강제 베팅 |

---

## 12. 버전 히스토리

### v11.8.3 (2025-01-16) ✅ **최신**
**🐛 점진적 성능 저하 해결 (Progressive Slowdown Fix)**

**문제**:
- 시간이 지날수록 입력 응답 속도가 느려지는 현상
- Hot Reload/페이지 재로드 시 setInterval 누적 생성
- init() 중복 실행으로 Event Listener 중복 등록

**해결**:
- ✅ **init() 중복 방지**: `isInitialized` 플래그로 중복 초기화 차단
- ✅ **setInterval 누적 방지**: `keepAliveInterval` 전역 변수로 관리
- ✅ **리소스 정리**: `beforeunload` 이벤트로 페이지 종료 시 interval 정리

**성능 영향**:
- 1회 입력 = 10회 입력 = 100회 입력 (동일한 응답 속도)
- 개발 환경: Hot Reload 시 메모리 누수 방지
- 프로덕션: 장시간 사용 시 일관된 응답 속도 유지

**기술적 세부사항**:
```javascript
// BEFORE
function startSessionKeepAlive() {
  setInterval(() => { ... }, 4 * 60 * 1000); // ❌ 중복 생성
}

// AFTER
let keepAliveInterval = null;
function startSessionKeepAlive() {
  if (keepAliveInterval) clearInterval(keepAliveInterval); // ✅ 정리
  keepAliveInterval = setInterval(() => { ... }, 4 * 60 * 1000);
}
```

### v11.8.2 (2025-01-16)
**⚡ C열 하이브리드 캐싱 (CacheService + PropertiesService)**
- ✅ **Primary Cache**: CacheService (6시간 TTL, 100KB 지원)
- ✅ **Backup Cache**: PropertiesService (영구 저장, 일일 캐시)
- ✅ **성능**: 762ms → 5ms (99.3% 절감, 2회차부터)
- 🎯 **안정성**: 11.5KB C열 데이터 캐싱 성공 (이전 9KB 제한 초과 해결)

### v11.8.1 (2025-01-16)
**🔧 K열 PRD 준수 (소프트 콘텐츠 정보)**
- ✅ **PU 모드**: "소프트 콘텐츠\n'플레이어 업데이트'" (2줄 형식)
- ✅ **L3 모드**: "소프트 콘텐츠\n'플레이어 소개'" (2줄 형식)
- 🐛 **수정**: "미완료" 오류 입력 → PRD 요구사항 준수

### v11.8.0 (2025-01-16)
**⚡ 성능 최적화 4종 세트 (응답 속도 97% 단축)**
- ✅ **Priority 1: Session Keep-Alive** - Cold Start 제거 (19.6s → 0s)
- ✅ **Priority 2: C~J열 행 단위 읽기** - 1행만 읽기 (1,475ms → 50ms)
- ✅ **Priority 3: SC Number 동기화 연장** - 30분 → 2시간
- ✅ **Priority 4: Type Rows TTL 연장** - 5분 → 30분

**성능 비교**:
| 최적화 | Before | After | 절감 |
|--------|--------|-------|------|
| Cold Start 제거 | 19.6s | 0s | 100% |
| C~J열 읽기 | 1,475ms | 50ms | 97% |
| SC 동기화 빈도 | 30분마다 | 2시간마다 | 75% |
| Type Rows 캐시 | 5분 | 30분 | 83% |
| **총 전송 시간** | **22.8s** | **0.8s** | **97%** |

### v11.3.7 (2025-01-16)
**🚀 성능 최적화: SC 번호 캐싱**
- ✅ `getCachedSCNumber()` 함수 추가: CacheService를 사용한 SC 번호 캐싱
- ✅ 캐시 TTL: 5분 (300초)
- ✅ 성능: 10.9초 → ~1초 (90% 개선)

---

## 📞 문의
기능 추가 요청이나 버그 제보는 개발팀에 문의하세요.
